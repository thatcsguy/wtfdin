<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WTFDIN - What The Fuck Do I Need?</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --border: #2a2a4a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            color: var(--accent);
        }

        .sidebar-header p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-export {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            flex: 1;
        }

        .btn-export:hover {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .btn-export:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .character-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .character-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .character-list-header h2 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn {
            background-color: var(--accent);
            color: var(--text-primary);
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: var(--accent-hover);
        }

        .btn:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn:focus:not(:focus-visible) {
            outline: none;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        .character-item {
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: background-color 0.2s;
        }

        .character-item:hover {
            background-color: var(--bg-tertiary);
        }

        .character-item:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
            background-color: var(--bg-tertiary);
        }

        .character-item.selected {
            background-color: var(--bg-tertiary);
            border-left: 3px solid var(--accent);
        }

        .character-item .name {
            font-weight: 500;
        }

        .character-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .character-item:hover .character-item-actions {
            opacity: 1;
        }

        .character-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-delete {
            background-color: transparent;
            color: var(--text-secondary);
            padding: 4px 8px;
            font-size: 0.75rem;
            border: 1px solid var(--border);
        }

        .btn-delete:hover {
            background-color: rgba(233, 69, 96, 0.2);
            color: var(--accent);
            border-color: var(--accent);
        }

        .btn-delete:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn-rename {
            background-color: transparent;
            color: var(--text-secondary);
            padding: 4px 8px;
            font-size: 0.75rem;
            border: 1px solid var(--border);
        }

        .btn-rename:hover {
            background-color: rgba(100, 149, 237, 0.2);
            color: #6495ed;
            border-color: #6495ed;
        }

        .btn-rename:focus-visible {
            outline: 2px solid #6495ed;
            outline-offset: 2px;
        }

        .no-characters {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-align: center;
            padding: 20px;
        }

        /* Main Panel */
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-header h2 {
            font-size: 1.5rem;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-state p {
            margin-bottom: 16px;
        }

        /* Job Pills */
        .job-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .job-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .job-pill:hover {
            background-color: var(--bg-tertiary);
        }

        .job-pill:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            background-color: var(--bg-tertiary);
        }

        .job-pill.selected {
            background-color: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .job-pill img {
            width: 24px;
            height: 24px;
        }

        .job-pill img.hidden {
            display: none;
        }

        .job-pill .job-icon-fallback {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .job-pill span {
            font-size: 0.875rem;
        }

        .job-pill .job-remove-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            margin-left: 4px;
            background-color: rgba(233, 69, 96, 0.3);
            border: none;
            border-radius: 50%;
            color: var(--accent);
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .job-pill:hover .job-remove-btn {
            display: flex;
        }

        .job-pill .job-remove-btn:hover {
            background-color: var(--accent);
            color: var(--text-primary);
        }

        .job-pill .job-remove-btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 1px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 16px;
            color: var(--accent);
        }

        .job-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
        }

        .job-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .job-grid-item:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .job-grid-item:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            background-color: var(--bg-tertiary);
        }

        .job-grid-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .job-grid-item img {
            width: 40px;
            height: 40px;
            margin-bottom: 6px;
        }

        .job-grid-item img.hidden {
            display: none;
        }

        .job-grid-item .job-icon-fallback {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .job-grid-item span {
            font-size: 0.75rem;
            text-align: center;
        }

        .job-category {
            margin-bottom: 20px;
        }

        .job-category h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .modal-close {
            margin-top: 16px;
            width: 100%;
        }

        .modal-small {
            max-width: 400px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--bg-primary);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background-color: var(--accent);
        }

        .btn-danger:hover {
            background-color: var(--accent-hover);
        }

        .modal-message {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .bis-config-step {
            display: none;
        }

        .bis-config-step.active {
            display: block;
        }

        .bis-option-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .bis-option-btn {
            flex: 1;
            padding: 16px;
            background-color: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .bis-option-btn:hover {
            border-color: var(--accent);
            background-color: var(--bg-tertiary);
        }

        .bis-option-btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .bis-option-btn h4 {
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .bis-option-btn p {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin: 0;
        }

        .bis-slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .bis-slot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .bis-slot-item .slot-name {
            font-size: 0.875rem;
        }

        .bis-slot-toggle {
            display: flex;
            gap: 4px;
        }

        .bis-slot-toggle button {
            padding: 4px 8px;
            font-size: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .bis-slot-toggle button.active {
            background-color: var(--accent);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .bis-slot-toggle button:hover:not(.active) {
            background-color: var(--bg-tertiary);
        }

        .modal-back-btn {
            margin-right: auto;
        }

        .no-jobs {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .job-info {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .job-info h3 {
            margin-bottom: 12px;
            color: var(--accent);
        }

        /* Gear Table */
        .gear-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .gear-table th,
        .gear-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .gear-table th {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .gear-table td {
            font-size: 0.875rem;
        }

        .gear-table tr:hover {
            background-color: var(--bg-tertiary);
        }

        .slot-name {
            font-weight: 500;
        }

        .slot-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slot-type:hover {
            transform: scale(1.05);
        }

        .slot-type:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .slot-type.raid {
            background-color: rgba(233, 69, 96, 0.2);
            color: var(--accent);
        }

        .slot-type.raid:hover {
            background-color: rgba(233, 69, 96, 0.35);
        }

        .slot-type.tome {
            background-color: rgba(100, 149, 237, 0.2);
            color: #6495ed;
        }

        .slot-type.tome:hover {
            background-color: rgba(100, 149, 237, 0.35);
        }

        .turn-label {
            display: inline-block;
            margin-left: 8px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .tome-cost {
            display: inline-block;
            margin-left: 8px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .tome-cost::after {
            content: ' tomes';
        }

        .gear-checkbox-group {
            display: flex;
            gap: 16px;
        }

        .gear-checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .gear-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .gear-checkbox-label input[type="checkbox"]:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .gear-checkbox-label:hover {
            color: var(--text-primary);
        }

        /* Slot completion states */
        .gear-table tr.slot-complete {
            background-color: rgba(46, 204, 113, 0.15);
        }

        .gear-table tr.slot-complete:hover {
            background-color: rgba(46, 204, 113, 0.25);
        }

        .gear-table tr.slot-partial {
            background-color: rgba(241, 196, 15, 0.15);
        }

        .gear-table tr.slot-partial:hover {
            background-color: rgba(241, 196, 15, 0.25);
        }

        /* Progress indicator */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background-color: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .progress-text.complete {
            color: #2ecc71;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 35vh;
            }

            .sidebar-header {
                padding: 12px 16px;
            }

            .sidebar-header h1 {
                font-size: 1.1rem;
            }

            .sidebar-header p {
                font-size: 0.7rem;
            }

            .character-list {
                padding: 8px;
            }

            .character-list-header {
                margin-bottom: 8px;
            }

            /* Tap-friendly buttons - minimum 44px touch target */
            .btn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 0.875rem;
            }

            .btn-small {
                min-height: 44px;
                padding: 10px 12px;
            }

            /* Character item tap-friendly */
            .character-item {
                padding: 14px 12px;
                min-height: 44px;
            }

            /* Always show character actions on mobile */
            .character-item-actions {
                opacity: 1;
            }

            .btn-delete, .btn-rename {
                min-height: 36px;
                padding: 8px 10px;
            }

            /* Main panel */
            .main-header {
                padding: 12px 16px;
            }

            .main-header h2 {
                font-size: 1.25rem;
            }

            .main-content {
                padding: 12px 16px;
            }

            /* Job pills tap-friendly */
            .job-pill {
                padding: 10px 14px;
                min-height: 44px;
            }

            .job-pill .job-remove-btn {
                display: flex;
                width: 24px;
                height: 24px;
            }

            /* Gear table mobile layout */
            .gear-table th,
            .gear-table td {
                padding: 10px 6px;
                font-size: 0.8rem;
            }

            .gear-table th {
                font-size: 0.65rem;
            }

            .slot-name {
                font-size: 0.8rem;
            }

            .slot-type {
                padding: 2px 6px;
                font-size: 0.65rem;
            }

            /* Stack checkboxes vertically on mobile */
            .gear-checkbox-group {
                flex-direction: column;
                gap: 8px;
            }

            .gear-checkbox-label {
                min-height: 44px;
                display: flex;
                align-items: center;
                padding: 8px 4px;
            }

            .gear-checkbox-label input[type="checkbox"] {
                width: 22px;
                height: 22px;
            }

            /* Progress bar */
            .progress-container {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .progress-text {
                text-align: center;
            }

            /* Modal mobile */
            .modal {
                padding: 16px;
                width: 95%;
                max-height: 90vh;
            }

            .job-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
            }

            .job-grid-item {
                padding: 10px 6px;
                min-height: 44px;
            }

            .job-grid-item img {
                width: 32px;
                height: 32px;
            }

            .job-grid-item .job-icon-fallback {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>WTFDIN</h1>
                <p>What The Fuck Do I Need?</p>
                <div class="sidebar-actions">
                    <button class="btn btn-small btn-export" id="export-btn">Export URL</button>
                </div>
            </div>
            <div class="character-list">
                <div class="character-list-header">
                    <h2>Characters</h2>
                    <button class="btn btn-small" id="add-character-btn">+ Add</button>
                </div>
                <div id="character-list-container">
                    <p class="no-characters">No characters yet. Add one to get started!</p>
                </div>
            </div>
        </aside>
        <main class="main-panel">
            <div class="main-header">
                <h2 id="character-name">Select a Character</h2>
            </div>
            <div class="main-content">
                <div class="empty-state" id="empty-state">
                    <p>Select a character from the sidebar to view their gear progress.</p>
                </div>
                <div id="character-details" style="display: none;">
                    <!-- Character details will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Job Picker Modal -->
    <div class="modal-overlay hidden" id="job-modal">
        <div class="modal">
            <h3 id="job-modal-title">Add Job</h3>
            <div id="job-modal-step1" class="bis-config-step active">
                <div id="job-modal-content"></div>
            </div>
            <div id="job-modal-step2" class="bis-config-step">
                <div id="bis-config-content"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary modal-back-btn hidden" id="job-modal-back">Back</button>
                <button class="btn modal-close" id="job-modal-close">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Input Modal (Rename/Add Character) -->
    <div class="modal-overlay hidden" id="input-modal">
        <div class="modal modal-small">
            <h3 id="input-modal-title">Enter Name</h3>
            <input type="text" id="input-modal-field" class="modal-input" placeholder="Enter name...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="input-modal-cancel">Cancel</button>
                <button class="btn" id="input-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal (Delete/Remove) -->
    <div class="modal-overlay hidden" id="confirm-modal">
        <div class="modal modal-small">
            <h3 id="confirm-modal-title">Confirm</h3>
            <p id="confirm-modal-message" class="modal-message"></p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="confirm-modal-cancel">Cancel</button>
                <button class="btn btn-danger" id="confirm-modal-confirm">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // WTFDIN - What The Fuck Do I Need?
        // Vanilla JS FFXIV Gear Tracker

        (function() {
            'use strict';

            // FFXIV Job Data with XIVAPI icons
            const JOBS = {
                tanks: [
                    { id: 'PLD', name: 'Paladin', icon: 'https://xivapi.com/cj/1/paladin.png' },
                    { id: 'WAR', name: 'Warrior', icon: 'https://xivapi.com/cj/1/warrior.png' },
                    { id: 'DRK', name: 'Dark Knight', icon: 'https://xivapi.com/cj/1/darkknight.png' },
                    { id: 'GNB', name: 'Gunbreaker', icon: 'https://xivapi.com/cj/1/gunbreaker.png' }
                ],
                healers: [
                    { id: 'WHM', name: 'White Mage', icon: 'https://xivapi.com/cj/1/whitemage.png' },
                    { id: 'SCH', name: 'Scholar', icon: 'https://xivapi.com/cj/1/scholar.png' },
                    { id: 'AST', name: 'Astrologian', icon: 'https://xivapi.com/cj/1/astrologian.png' },
                    { id: 'SGE', name: 'Sage', icon: 'https://xivapi.com/cj/1/sage.png' }
                ],
                melee: [
                    { id: 'MNK', name: 'Monk', icon: 'https://xivapi.com/cj/1/monk.png' },
                    { id: 'DRG', name: 'Dragoon', icon: 'https://xivapi.com/cj/1/dragoon.png' },
                    { id: 'NIN', name: 'Ninja', icon: 'https://xivapi.com/cj/1/ninja.png' },
                    { id: 'SAM', name: 'Samurai', icon: 'https://xivapi.com/cj/1/samurai.png' },
                    { id: 'RPR', name: 'Reaper', icon: 'https://xivapi.com/cj/1/reaper.png' },
                    { id: 'VPR', name: 'Viper', icon: 'https://xivapi.com/cj/1/viper.png' }
                ],
                ranged: [
                    { id: 'BRD', name: 'Bard', icon: 'https://xivapi.com/cj/1/bard.png' },
                    { id: 'MCH', name: 'Machinist', icon: 'https://xivapi.com/cj/1/machinist.png' },
                    { id: 'DNC', name: 'Dancer', icon: 'https://xivapi.com/cj/1/dancer.png' }
                ],
                casters: [
                    { id: 'BLM', name: 'Black Mage', icon: 'https://xivapi.com/cj/1/blackmage.png' },
                    { id: 'SMN', name: 'Summoner', icon: 'https://xivapi.com/cj/1/summoner.png' },
                    { id: 'RDM', name: 'Red Mage', icon: 'https://xivapi.com/cj/1/redmage.png' },
                    { id: 'PCT', name: 'Pictomancer', icon: 'https://xivapi.com/cj/1/pictomancer.png' }
                ]
            };

            const JOB_CATEGORIES = [
                { key: 'tanks', label: 'Tanks' },
                { key: 'healers', label: 'Healers' },
                { key: 'melee', label: 'Melee DPS' },
                { key: 'ranged', label: 'Physical Ranged' },
                { key: 'casters', label: 'Magical Ranged' }
            ];

            // Equipment slots - all 11 gear slots
            const GEAR_SLOTS = [
                { id: 'weapon', name: 'Weapon' },
                { id: 'head', name: 'Head' },
                { id: 'body', name: 'Body' },
                { id: 'hands', name: 'Hands' },
                { id: 'legs', name: 'Legs' },
                { id: 'feet', name: 'Feet' },
                { id: 'earrings', name: 'Earrings' },
                { id: 'necklace', name: 'Necklace' },
                { id: 'bracelets', name: 'Bracelets' },
                { id: 'ring1', name: 'Ring 1' },
                { id: 'ring2', name: 'Ring 2' }
            ];

            // BiS presets per job - based on typical FFXIV endgame stat priorities
            // Jobs prioritizing different secondary stats have different BiS gear
            // Pattern: Weapon always raid, armor/accessories vary by job
            const JOB_BIS_PRESETS = {
                // Tanks - generally want Tenacity/DH or Crit builds
                PLD: { weapon: 'raid', head: 'tome', body: 'raid', hands: 'tome', legs: 'raid', feet: 'tome', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                WAR: { weapon: 'raid', head: 'raid', body: 'tome', hands: 'raid', legs: 'tome', feet: 'raid', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },
                DRK: { weapon: 'raid', head: 'tome', body: 'raid', hands: 'raid', legs: 'tome', feet: 'tome', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                GNB: { weapon: 'raid', head: 'raid', body: 'raid', hands: 'tome', legs: 'tome', feet: 'raid', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },

                // Healers - Crit/Det or Piety builds
                WHM: { weapon: 'raid', head: 'tome', body: 'tome', hands: 'raid', legs: 'raid', feet: 'tome', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },
                SCH: { weapon: 'raid', head: 'raid', body: 'tome', hands: 'tome', legs: 'raid', feet: 'raid', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'raid', ring2: 'raid' },
                AST: { weapon: 'raid', head: 'tome', body: 'raid', hands: 'tome', legs: 'tome', feet: 'raid', earrings: 'tome', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'tome' },
                SGE: { weapon: 'raid', head: 'raid', body: 'raid', hands: 'tome', legs: 'tome', feet: 'tome', earrings: 'raid', necklace: 'raid', bracelets: 'tome', ring1: 'tome', ring2: 'raid' },

                // Melee DPS - Crit/DH focused
                MNK: { weapon: 'raid', head: 'raid', body: 'tome', hands: 'raid', legs: 'raid', feet: 'tome', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                DRG: { weapon: 'raid', head: 'tome', body: 'raid', hands: 'raid', legs: 'tome', feet: 'raid', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },
                NIN: { weapon: 'raid', head: 'raid', body: 'raid', hands: 'tome', legs: 'tome', feet: 'raid', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                SAM: { weapon: 'raid', head: 'tome', body: 'tome', hands: 'raid', legs: 'raid', feet: 'tome', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },
                RPR: { weapon: 'raid', head: 'raid', body: 'tome', hands: 'tome', legs: 'raid', feet: 'raid', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                VPR: { weapon: 'raid', head: 'tome', body: 'raid', hands: 'raid', legs: 'tome', feet: 'tome', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },

                // Physical Ranged - Crit/DH focused
                BRD: { weapon: 'raid', head: 'raid', body: 'tome', hands: 'raid', legs: 'tome', feet: 'raid', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },
                MCH: { weapon: 'raid', head: 'tome', body: 'raid', hands: 'tome', legs: 'raid', feet: 'tome', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                DNC: { weapon: 'raid', head: 'raid', body: 'raid', hands: 'tome', legs: 'tome', feet: 'raid', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },

                // Casters - SpS or Crit builds vary
                BLM: { weapon: 'raid', head: 'tome', body: 'tome', hands: 'raid', legs: 'raid', feet: 'tome', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                SMN: { weapon: 'raid', head: 'raid', body: 'tome', hands: 'raid', legs: 'tome', feet: 'raid', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' },
                RDM: { weapon: 'raid', head: 'tome', body: 'raid', hands: 'tome', legs: 'tome', feet: 'raid', earrings: 'raid', necklace: 'tome', bracelets: 'raid', ring1: 'tome', ring2: 'raid' },
                PCT: { weapon: 'raid', head: 'raid', body: 'raid', hands: 'tome', legs: 'raid', feet: 'tome', earrings: 'tome', necklace: 'raid', bracelets: 'tome', ring1: 'raid', ring2: 'tome' }
            };

            // Raid turn mapping - which boss drops which slot
            const RAID_TURNS = {
                weapon: { turn: 4, label: '4th Turn' },
                head: { turn: 2, label: '2nd Turn' },
                body: { turn: 3, label: '3rd Turn' },
                hands: { turn: 2, label: '2nd Turn' },
                legs: { turn: 3, label: '3rd Turn' },
                feet: { turn: 2, label: '2nd Turn' },
                earrings: { turn: 1, label: '1st Turn' },
                necklace: { turn: 1, label: '1st Turn' },
                bracelets: { turn: 1, label: '1st Turn' },
                ring1: { turn: 1, label: '1st Turn' },
                ring2: { turn: 1, label: '1st Turn' }
            };

            // Tomestone cost mapping - how many tomes each slot costs
            const TOME_COSTS = {
                weapon: 500,
                head: 495,
                body: 825,
                hands: 495,
                legs: 825,
                feet: 495,
                earrings: 375,
                necklace: 375,
                bracelets: 375,
                ring1: 375,
                ring2: 375
            };

            // Fallback default BiS preset
            const DEFAULT_BIS = {
                weapon: 'raid',
                head: 'tome',
                body: 'raid',
                hands: 'raid',
                legs: 'tome',
                feet: 'tome',
                earrings: 'tome',
                necklace: 'raid',
                bracelets: 'tome',
                ring1: 'raid',
                ring2: 'tome'
            };

            // Get BiS preset for a job
            function getBiSPreset(jobId) {
                return JOB_BIS_PRESETS[jobId] || DEFAULT_BIS;
            }

            // Get effective slot type (override or preset)
            function getSlotType(jobId, slotId, slotTypeOverrides) {
                if (slotTypeOverrides && slotTypeOverrides[slotId]) {
                    return slotTypeOverrides[slotId];
                }
                const preset = getBiSPreset(jobId);
                return preset[slotId];
            }

            // Calculate job completion progress
            // Returns { complete: number, total: number }
            // Tome slots only count as complete when upgraded=true
            function calculateJobProgress(jobId, gear, slotTypeOverrides) {
                let complete = 0;
                const total = GEAR_SLOTS.length;

                GEAR_SLOTS.forEach(slot => {
                    const slotType = getSlotType(jobId, slot.id, slotTypeOverrides);
                    const slotGear = gear[slot.id] || {};

                    if (slotType === 'raid') {
                        if (slotGear.have) complete++;
                    } else {
                        // Tome: only complete when upgraded
                        if (slotGear.upgraded) complete++;
                    }
                });

                return { complete, total };
            }

            // Get flat list of all jobs
            function getAllJobs() {
                return Object.values(JOBS).flat();
            }

            // Get job by ID
            function getJobById(id) {
                return getAllJobs().find(j => j.id === id);
            }

            // State
            let state = {
                characters: [],
                selectedCharacterId: null,
                selectedJobId: null
            };

            // Input modal callback
            let inputModalCallback = null;

            // Confirm modal callback
            let confirmModalCallback = null;

            // DOM Elements
            const addCharacterBtn = document.getElementById('add-character-btn');
            const characterListContainer = document.getElementById('character-list-container');
            const characterNameHeader = document.getElementById('character-name');
            const emptyState = document.getElementById('empty-state');
            const characterDetails = document.getElementById('character-details');
            const jobModal = document.getElementById('job-modal');
            const jobModalTitle = document.getElementById('job-modal-title');
            const jobModalContent = document.getElementById('job-modal-content');
            const jobModalStep1 = document.getElementById('job-modal-step1');
            const jobModalStep2 = document.getElementById('job-modal-step2');
            const bisConfigContent = document.getElementById('bis-config-content');
            const jobModalBack = document.getElementById('job-modal-back');
            const jobModalClose = document.getElementById('job-modal-close');
            const exportBtn = document.getElementById('export-btn');

            // Job modal state
            let pendingJobId = null;
            let manualSlotConfig = {};
            const inputModal = document.getElementById('input-modal');
            const inputModalTitle = document.getElementById('input-modal-title');
            const inputModalField = document.getElementById('input-modal-field');
            const inputModalCancel = document.getElementById('input-modal-cancel');
            const inputModalConfirm = document.getElementById('input-modal-confirm');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmModalCancel = document.getElementById('confirm-modal-cancel');
            const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm');

            // Initialize
            function init() {
                loadState();
                checkForImport();
                render();
                attachEventListeners();
            }

            // Check URL for data parameter and prompt import
            function checkForImport() {
                const urlParams = new URLSearchParams(window.location.search);
                const dataParam = urlParams.get('data');

                if (!dataParam) return;

                try {
                    // Decode the base64 data
                    const jsonStr = decodeURIComponent(atob(dataParam));
                    const importedState = JSON.parse(jsonStr);

                    // Validate imported data structure
                    if (!importedState || !Array.isArray(importedState.characters)) {
                        throw new Error('Invalid data format');
                    }

                    // Count characters and jobs for prompt
                    const charCount = importedState.characters.length;
                    let jobCount = 0;
                    importedState.characters.forEach(c => {
                        if (c.jobs) jobCount += c.jobs.length;
                    });

                    // Prompt user
                    const msg = `Import ${charCount} character(s) with ${jobCount} job(s)?\n\nThis will replace your current data.`;
                    if (confirm(msg)) {
                        // Apply imported state
                        state = importedState;
                        saveState();
                    }

                    // Clean URL (remove data param) regardless of choice
                    const url = new URL(window.location.href);
                    url.search = '';
                    window.history.replaceState({}, '', url.toString());

                } catch (e) {
                    console.error('Import failed:', e);
                    alert('Failed to import data: Invalid or corrupted URL.');

                    // Clean URL
                    const url = new URL(window.location.href);
                    url.search = '';
                    window.history.replaceState({}, '', url.toString());
                }
            }

            // Local Storage
            function loadState() {
                const saved = localStorage.getItem('wtfdin-data');
                if (saved) {
                    try {
                        state = JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse saved state:', e);
                    }
                }
            }

            function saveState() {
                localStorage.setItem('wtfdin-data', JSON.stringify(state));
            }

            // Event Listeners
            function attachEventListeners() {
                addCharacterBtn.addEventListener('click', handleAddCharacter);
                jobModalClose.addEventListener('click', closeJobModal);
                jobModalBack.addEventListener('click', handleJobModalBack);
                jobModal.addEventListener('click', (e) => {
                    if (e.target === jobModal) closeJobModal();
                });
                exportBtn.addEventListener('click', handleExport);

                // Input modal events
                inputModalCancel.addEventListener('click', closeInputModal);
                inputModalConfirm.addEventListener('click', handleInputModalConfirm);
                inputModal.addEventListener('click', (e) => {
                    if (e.target === inputModal) closeInputModal();
                });
                inputModalField.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleInputModalConfirm();
                    if (e.key === 'Escape') closeInputModal();
                });

                // Confirm modal events
                confirmModalCancel.addEventListener('click', closeConfirmModal);
                confirmModalConfirmBtn.addEventListener('click', handleConfirmModalConfirm);
                confirmModal.addEventListener('click', (e) => {
                    if (e.target === confirmModal) closeConfirmModal();
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !confirmModal.classList.contains('hidden')) {
                        closeConfirmModal();
                    }
                });
            }

            // Input Modal Functions
            function openInputModal(title, defaultValue, confirmText, callback) {
                inputModalTitle.textContent = title;
                inputModalField.value = defaultValue || '';
                inputModalConfirm.textContent = confirmText || 'Confirm';
                inputModalCallback = callback;
                inputModal.classList.remove('hidden');
                inputModalField.focus();
                inputModalField.select();
            }

            function closeInputModal() {
                inputModal.classList.add('hidden');
                inputModalCallback = null;
                inputModalField.value = '';
            }

            function handleInputModalConfirm() {
                const value = inputModalField.value.trim();
                if (inputModalCallback) {
                    inputModalCallback(value);
                }
                closeInputModal();
            }

            // Confirm Modal Functions
            function openConfirmModal(title, message, confirmText, callback) {
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModalConfirmBtn.textContent = confirmText || 'Delete';
                confirmModalCallback = callback;
                confirmModal.classList.remove('hidden');
                confirmModalConfirmBtn.focus();
            }

            function closeConfirmModal() {
                confirmModal.classList.add('hidden');
                confirmModalCallback = null;
            }

            function handleConfirmModalConfirm() {
                if (confirmModalCallback) {
                    confirmModalCallback();
                }
                closeConfirmModal();
            }

            // Export/Import
            function handleExport() {
                if (state.characters.length === 0) {
                    alert('No data to export. Add some characters first!');
                    return;
                }

                try {
                    // Encode state as base64
                    const jsonStr = JSON.stringify(state);
                    const base64 = btoa(encodeURIComponent(jsonStr));

                    // Build URL with data parameter
                    const url = new URL(window.location.href);
                    url.search = ''; // Clear existing params
                    url.searchParams.set('data', base64);

                    // Copy to clipboard
                    navigator.clipboard.writeText(url.toString()).then(() => {
                        alert('URL copied to clipboard!');
                    }).catch(() => {
                        // Fallback: show URL in prompt
                        prompt('Copy this URL to share your data:', url.toString());
                    });
                } catch (e) {
                    console.error('Export failed:', e);
                    alert('Failed to export data. See console for details.');
                }
            }

            function handleAddCharacter() {
                openInputModal('Add Character', '', 'Create', (name) => {
                    if (name) {
                        const character = {
                            id: Date.now().toString(),
                            name: name,
                            jobs: []
                        };
                        state.characters.push(character);
                        state.selectedCharacterId = character.id;
                        saveState();
                        render();
                    }
                });
            }

            function selectCharacter(id) {
                state.selectedCharacterId = id;
                // Auto-select first job if character has jobs
                const char = state.characters.find(c => c.id === id);
                if (char && char.jobs.length > 0) {
                    state.selectedJobId = char.jobs[0].jobId;
                } else {
                    state.selectedJobId = null;
                }
                saveState();
                render();
            }

            function handleRenameCharacter(id) {
                const char = state.characters.find(c => c.id === id);
                if (!char) return;

                openInputModal('Rename Character', char.name, 'Confirm', (newName) => {
                    if (newName && newName !== char.name) {
                        char.name = newName;
                        saveState();
                        render();
                    }
                });
            }

            function handleDeleteCharacter(id) {
                const char = state.characters.find(c => c.id === id);
                if (!char) return;

                openConfirmModal(
                    'Delete Character',
                    `Delete "${char.name}" and all their job data?`,
                    'Delete',
                    () => {
                        // Remove character from array
                        state.characters = state.characters.filter(c => c.id !== id);

                        // Clear selection if deleted character was selected
                        if (state.selectedCharacterId === id) {
                            state.selectedCharacterId = state.characters.length > 0 ? state.characters[0].id : null;
                            state.selectedJobId = null;
                            // Auto-select first job of new selected character
                            if (state.selectedCharacterId) {
                                const newSelected = state.characters.find(c => c.id === state.selectedCharacterId);
                                if (newSelected && newSelected.jobs.length > 0) {
                                    state.selectedJobId = newSelected.jobs[0].jobId;
                                }
                            }
                        }

                        saveState();
                        render();
                    }
                );
            }

            function selectJob(jobId) {
                state.selectedJobId = jobId;
                saveState();
                render();
            }

            function handleRemoveJob(jobId) {
                const selected = state.characters.find(c => c.id === state.selectedCharacterId);
                if (!selected) return;

                const job = getJobById(jobId);
                const jobName = job ? job.name : jobId;

                openConfirmModal(
                    'Remove Job',
                    `Remove ${jobName} and all its gear data?`,
                    'Remove',
                    () => {
                        // Remove job from character
                        selected.jobs = selected.jobs.filter(j => j.jobId !== jobId);

                        // Clear selected job if removed job was selected
                        if (state.selectedJobId === jobId) {
                            state.selectedJobId = selected.jobs.length > 0 ? selected.jobs[0].jobId : null;
                        }

                        saveState();
                        render();
                    }
                );
            }

            // Job Modal
            function openJobModal() {
                const selected = state.characters.find(c => c.id === state.selectedCharacterId);
                if (!selected) return;

                // Reset to step 1
                pendingJobId = null;
                manualSlotConfig = {};
                showJobModalStep(1);

                const existingJobIds = selected.jobs.map(j => j.jobId);

                let html = '';
                JOB_CATEGORIES.forEach(cat => {
                    html += `<div class="job-category"><h4>${cat.label}</h4><div class="job-grid">`;
                    JOBS[cat.key].forEach(job => {
                        const isDisabled = existingJobIds.includes(job.id);
                        html += `
                            <div class="job-grid-item ${isDisabled ? 'disabled' : ''}"
                                 data-job-id="${job.id}"
                                 ${isDisabled ? '' : 'tabindex="0"'}>
                                <img src="${job.icon}" alt="${job.name}" data-job-id="${job.id}">
                                <span>${job.name}</span>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                });

                jobModalContent.innerHTML = html;

                // Attach click handlers to job items
                jobModalContent.querySelectorAll('.job-grid-item:not(.disabled)').forEach(item => {
                    item.addEventListener('click', () => showBisConfigStep(item.dataset.jobId));
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            showBisConfigStep(item.dataset.jobId);
                        }
                    });
                });

                // Attach job icon error handlers for modal
                jobModalContent.querySelectorAll('.job-grid-item img').forEach(img => {
                    img.onerror = () => handleJobIconError(img, img.dataset.jobId);
                });

                jobModal.classList.remove('hidden');
            }

            function showJobModalStep(step) {
                if (step === 1) {
                    jobModalTitle.textContent = 'Add Job';
                    jobModalStep1.classList.add('active');
                    jobModalStep2.classList.remove('active');
                    jobModalBack.classList.add('hidden');
                } else {
                    const job = getJobById(pendingJobId);
                    jobModalTitle.textContent = `Configure ${job ? job.name : ''} BiS`;
                    jobModalStep1.classList.remove('active');
                    jobModalStep2.classList.add('active');
                    jobModalBack.classList.remove('hidden');
                }
            }

            function handleJobModalBack() {
                pendingJobId = null;
                manualSlotConfig = {};
                showJobModalStep(1);
            }

            function showBisConfigStep(jobId) {
                pendingJobId = jobId;
                const preset = getBiSPreset(jobId);

                // Initialize manual config with preset values
                manualSlotConfig = { ...preset };

                const job = getJobById(jobId);

                let html = `
                    <div class="bis-option-buttons">
                        <button class="bis-option-btn" id="use-preset-btn" tabindex="0">
                            <h4>Use Preset BiS</h4>
                            <p>Apply recommended gear configuration</p>
                        </button>
                        <button class="bis-option-btn" id="use-manual-btn" tabindex="0">
                            <h4>Configure Manually</h4>
                            <p>Choose raid/tome for each slot</p>
                        </button>
                    </div>
                    <div id="manual-config-section" style="display: none;">
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 12px;">Toggle each slot between Raid and Tome:</p>
                        <div class="bis-slot-grid">
                `;

                GEAR_SLOTS.forEach(slot => {
                    const slotType = manualSlotConfig[slot.id] || 'raid';
                    html += `
                        <div class="bis-slot-item">
                            <span class="slot-name">${slot.name}</span>
                            <div class="bis-slot-toggle" data-slot="${slot.id}">
                                <button data-type="raid" class="${slotType === 'raid' ? 'active' : ''}">Raid</button>
                                <button data-type="tome" class="${slotType === 'tome' ? 'active' : ''}">Tome</button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                        <button class="btn" id="confirm-manual-btn" style="margin-top: 16px; width: 100%;">Add ${job ? job.name : 'Job'}</button>
                    </div>
                `;

                bisConfigContent.innerHTML = html;

                // Attach preset button handler
                document.getElementById('use-preset-btn').addEventListener('click', () => {
                    addJobWithConfig(jobId, null); // null = use preset
                });

                // Attach manual button handler
                document.getElementById('use-manual-btn').addEventListener('click', () => {
                    document.getElementById('manual-config-section').style.display = 'block';
                    document.querySelector('.bis-option-buttons').style.display = 'none';
                });

                // Attach slot toggle handlers
                bisConfigContent.querySelectorAll('.bis-slot-toggle').forEach(toggle => {
                    const slotId = toggle.dataset.slot;
                    toggle.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const type = btn.dataset.type;
                            manualSlotConfig[slotId] = type;
                            // Update active states
                            toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                        });
                    });
                });

                // Attach confirm manual button handler
                document.getElementById('confirm-manual-btn').addEventListener('click', () => {
                    addJobWithConfig(jobId, manualSlotConfig);
                });

                showJobModalStep(2);
            }

            function closeJobModal() {
                jobModal.classList.add('hidden');
                pendingJobId = null;
                manualSlotConfig = {};
            }

            function addJobWithConfig(jobId, slotOverrides) {
                const selected = state.characters.find(c => c.id === state.selectedCharacterId);
                if (!selected) return;

                // Check if job already exists
                if (selected.jobs.some(j => j.jobId === jobId)) return;

                // Build slot type overrides if manual config differs from preset
                let slotTypeOverrides = {};
                if (slotOverrides) {
                    const preset = getBiSPreset(jobId);
                    GEAR_SLOTS.forEach(slot => {
                        if (slotOverrides[slot.id] !== preset[slot.id]) {
                            slotTypeOverrides[slot.id] = slotOverrides[slot.id];
                        }
                    });
                }

                // Add job with empty gear slots and any overrides
                const jobData = {
                    jobId: jobId,
                    gear: {}
                };
                if (Object.keys(slotTypeOverrides).length > 0) {
                    jobData.slotTypeOverrides = slotTypeOverrides;
                }
                selected.jobs.push(jobData);

                // Auto-select the newly added job
                state.selectedJobId = jobId;

                saveState();
                closeJobModal();
                render();
            }

            // Rendering
            function render() {
                renderCharacterList();
                renderMainPanel();
            }

            function renderCharacterList() {
                if (state.characters.length === 0) {
                    characterListContainer.innerHTML = '<p class="no-characters">No characters yet. Add one to get started!</p>';
                    return;
                }

                characterListContainer.innerHTML = state.characters.map(char => `
                    <div class="character-item ${char.id === state.selectedCharacterId ? 'selected' : ''}"
                         data-id="${char.id}"
                         tabindex="0"
                         role="button">
                        <div class="character-item-row">
                            <span class="name">${escapeHtml(char.name)}</span>
                            <div class="character-item-actions">
                                <button class="btn btn-small btn-rename" data-rename-id="${char.id}">Rename</button>
                                <button class="btn btn-small btn-delete" data-delete-id="${char.id}">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Attach click handlers for selecting character
                characterListContainer.querySelectorAll('.character-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // Don't select if clicking action buttons
                        if (e.target.classList.contains('btn-delete') || e.target.classList.contains('btn-rename')) return;
                        selectCharacter(item.dataset.id);
                    });
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            selectCharacter(item.dataset.id);
                        }
                    });
                });

                // Attach rename handlers
                characterListContainer.querySelectorAll('.btn-rename').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleRenameCharacter(btn.dataset.renameId);
                    });
                });

                // Attach delete handlers
                characterListContainer.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleDeleteCharacter(btn.dataset.deleteId);
                    });
                });
            }

            function renderMainPanel() {
                const selected = state.characters.find(c => c.id === state.selectedCharacterId);

                if (!selected) {
                    characterNameHeader.textContent = 'Select a Character';
                    emptyState.style.display = 'flex';
                    characterDetails.style.display = 'none';
                    return;
                }

                characterNameHeader.textContent = selected.name;
                emptyState.style.display = 'none';
                characterDetails.style.display = 'block';

                // Render jobs
                let jobsHtml = '';
                if (selected.jobs.length > 0) {
                    jobsHtml = '<div class="job-pills">';
                    selected.jobs.forEach(j => {
                        const job = getJobById(j.jobId);
                        if (job) {
                            const isSelected = j.jobId === state.selectedJobId;
                            jobsHtml += `
                                <div class="job-pill ${isSelected ? 'selected' : ''}" data-job-id="${job.id}" tabindex="0">
                                    <img src="${job.icon}" alt="${job.name}" data-job-id="${job.id}">
                                    <span>${job.name}</span>
                                    <button class="job-remove-btn" data-remove-job-id="${job.id}" title="Remove ${job.name}">&times;</button>
                                </div>
                            `;
                        }
                    });
                    jobsHtml += '</div>';
                } else {
                    jobsHtml = '<p class="no-jobs">No jobs added yet.</p>';
                }

                // Get selected job info and gear table
                const selectedJob = state.selectedJobId ? getJobById(state.selectedJobId) : null;
                const selectedJobData = selected.jobs.find(j => j.jobId === state.selectedJobId);
                let jobInfoHtml = '';

                if (selectedJob && selectedJobData) {
                    const gear = selectedJobData.gear || {};
                    const slotTypeOverrides = selectedJobData.slotTypeOverrides || {};

                    let tableRows = '';
                    GEAR_SLOTS.forEach(slot => {
                        const slotType = getSlotType(selectedJob.id, slot.id, slotTypeOverrides);
                        const slotGear = gear[slot.id] || {};

                        let checkboxHtml = '';
                        if (slotType === 'raid') {
                            const hasItem = slotGear.have || false;
                            checkboxHtml = `
                                <label class="gear-checkbox-label">
                                    <input type="checkbox" data-slot="${slot.id}" data-field="have" ${hasItem ? 'checked' : ''}>
                                    Have
                                </label>
                            `;
                        } else {
                            // Tome item - has Base and Upgraded checkboxes
                            const hasBase = slotGear.base || false;
                            const hasUpgraded = slotGear.upgraded || false;
                            checkboxHtml = `
                                <label class="gear-checkbox-label">
                                    <input type="checkbox" data-slot="${slot.id}" data-field="base" ${hasBase ? 'checked' : ''}>
                                    Base
                                </label>
                                <label class="gear-checkbox-label">
                                    <input type="checkbox" data-slot="${slot.id}" data-field="upgraded" ${hasUpgraded ? 'checked' : ''}>
                                    Upgraded
                                </label>
                            `;
                        }

                        // Determine slot completion state
                        let slotClass = '';
                        if (slotType === 'raid') {
                            if (slotGear.have) slotClass = 'slot-complete';
                        } else {
                            // Tome: complete if upgraded, partial if base only
                            if (slotGear.upgraded) {
                                slotClass = 'slot-complete';
                            } else if (slotGear.base) {
                                slotClass = 'slot-partial';
                            }
                        }

                        // Build type cell content with turn label for raid or cost for tome
                        let typeLabel = slotType.charAt(0).toUpperCase() + slotType.slice(1);
                        let extraLabel = '';
                        if (slotType === 'raid') {
                            const turnInfo = RAID_TURNS[slot.id];
                            if (turnInfo) {
                                extraLabel = `<span class="turn-label">${turnInfo.label}</span>`;
                            }
                        } else if (slotType === 'tome') {
                            const cost = TOME_COSTS[slot.id];
                            if (cost) {
                                extraLabel = `<span class="tome-cost">${cost}</span>`;
                            }
                        }

                        tableRows += `
                            <tr class="${slotClass}">
                                <td class="slot-name">${slot.name}</td>
                                <td><span class="slot-type ${slotType}" data-slot="${slot.id}" data-type="${slotType}" tabindex="0" role="button" title="Click to toggle type">${typeLabel}</span>${extraLabel}</td>
                                <td><div class="gear-checkbox-group">${checkboxHtml}</div></td>
                            </tr>
                        `;
                    });

                    // Calculate progress
                    const progress = calculateJobProgress(selectedJob.id, gear, slotTypeOverrides);
                    const progressPercent = Math.round((progress.complete / progress.total) * 100);
                    const isComplete = progress.complete === progress.total;

                    jobInfoHtml = `
                        <div class="job-info">
                            <h3>${selectedJob.name} Gear</h3>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
                                </div>
                                <span class="progress-text ${isComplete ? 'complete' : ''}">${progress.complete}/${progress.total} slots complete</span>
                            </div>
                            <table class="gear-table">
                                <thead>
                                    <tr>
                                        <th>Slot</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                characterDetails.innerHTML = `
                    ${jobsHtml}
                    <button class="btn" id="add-job-btn">+ Add Job</button>
                    ${jobInfoHtml}
                `;

                // Attach add job button handler
                document.getElementById('add-job-btn').addEventListener('click', openJobModal);

                // Attach job pill click handlers
                characterDetails.querySelectorAll('.job-pill').forEach(pill => {
                    pill.addEventListener('click', (e) => {
                        // Don't select if clicking remove button
                        if (e.target.classList.contains('job-remove-btn')) return;
                        selectJob(pill.dataset.jobId);
                    });
                    pill.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            selectJob(pill.dataset.jobId);
                        }
                    });
                });

                // Attach job remove button handlers
                characterDetails.querySelectorAll('.job-remove-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleRemoveJob(btn.dataset.removeJobId);
                    });
                });

                // Attach job icon error handlers
                characterDetails.querySelectorAll('.job-pill img').forEach(img => {
                    img.onerror = () => handleJobIconError(img, img.dataset.jobId);
                });

                // Attach gear checkbox handlers
                characterDetails.querySelectorAll('.gear-table input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        handleGearCheckbox(e.target.dataset.slot, e.target.dataset.field, e.target.checked);
                    });
                });

                // Attach slot type toggle handlers
                characterDetails.querySelectorAll('.slot-type').forEach(badge => {
                    badge.addEventListener('click', () => {
                        handleSlotTypeToggle(badge.dataset.slot, badge.dataset.type);
                    });
                    badge.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleSlotTypeToggle(badge.dataset.slot, badge.dataset.type);
                        }
                    });
                });
            }

            // Ring validation helper
            // Returns { valid: boolean, message: string } for proposed ring state change
            function validateRingChange(jobId, gear, slotId, field, checked, slotTypeOverrides) {
                // Only validate ring slots
                if (slotId !== 'ring1' && slotId !== 'ring2') {
                    return { valid: true, message: '' };
                }

                // Only validate when checking (not unchecking)
                if (!checked) {
                    return { valid: true, message: '' };
                }

                const otherRingSlot = slotId === 'ring1' ? 'ring2' : 'ring1';
                const thisRingType = getSlotType(jobId, slotId, slotTypeOverrides);
                const otherRingType = getSlotType(jobId, otherRingSlot, slotTypeOverrides);
                const otherRingGear = gear[otherRingSlot] || {};

                // RING-001: Cannot have two raid rings
                if (field === 'have' && thisRingType === 'raid') {
                    if (otherRingType === 'raid' && otherRingGear.have) {
                        return {
                            valid: false,
                            message: 'Cannot have two raid rings equipped. You must uncheck the other raid ring first.'
                        };
                    }
                }

                // RING-002: Cannot have two tome rings at same upgrade level
                if (thisRingType === 'tome' && otherRingType === 'tome') {
                    if (field === 'base' && !checked) {
                        // Unchecking base is always allowed
                        return { valid: true, message: '' };
                    }

                    // Calculate what the state would be after this change
                    const thisGear = gear[slotId] || {};
                    let thisWouldBeBase = field === 'base' ? checked : (thisGear.base || false);
                    let thisWouldBeUpgraded = field === 'upgraded' ? checked : (thisGear.upgraded || false);

                    // If checking upgraded, base would also be auto-checked (GEAR-004)
                    if (field === 'upgraded' && checked) {
                        thisWouldBeBase = true;
                    }

                    const otherIsBase = otherRingGear.base || false;
                    const otherIsUpgraded = otherRingGear.upgraded || false;

                    // Check for duplicate base-only (neither upgraded)
                    if (thisWouldBeBase && !thisWouldBeUpgraded && otherIsBase && !otherIsUpgraded) {
                        return {
                            valid: false,
                            message: 'Cannot have two tome rings at the same upgrade level. Upgrade one ring first.'
                        };
                    }

                    // Check for duplicate upgraded
                    if (thisWouldBeUpgraded && otherIsUpgraded) {
                        return {
                            valid: false,
                            message: 'Cannot have two upgraded tome rings. You must uncheck the upgrade on one ring first.'
                        };
                    }
                }

                return { valid: true, message: '' };
            }

            function handleGearCheckbox(slotId, field, checked) {
                const selected = state.characters.find(c => c.id === state.selectedCharacterId);
                if (!selected) return;

                const jobData = selected.jobs.find(j => j.jobId === state.selectedJobId);
                if (!jobData) return;

                // Initialize gear object if needed
                if (!jobData.gear) jobData.gear = {};
                if (!jobData.gear[slotId]) jobData.gear[slotId] = {};

                // Validate ring changes
                const slotTypeOverrides = jobData.slotTypeOverrides || {};
                const validation = validateRingChange(state.selectedJobId, jobData.gear, slotId, field, checked, slotTypeOverrides);
                if (!validation.valid) {
                    alert(validation.message);
                    render(); // Re-render to reset checkbox state
                    return;
                }

                // Update the field
                jobData.gear[slotId][field] = checked;

                // GEAR-004: Auto-check Base when Upgraded is checked
                if (field === 'upgraded' && checked) {
                    jobData.gear[slotId].base = true;
                }

                saveState();
                render();
            }

            function handleSlotTypeToggle(slotId, currentType) {
                const selected = state.characters.find(c => c.id === state.selectedCharacterId);
                if (!selected) return;

                const jobData = selected.jobs.find(j => j.jobId === state.selectedJobId);
                if (!jobData) return;

                // Initialize slot type overrides if needed
                if (!jobData.slotTypeOverrides) jobData.slotTypeOverrides = {};

                // Toggle the type
                const newType = currentType === 'raid' ? 'tome' : 'raid';
                jobData.slotTypeOverrides[slotId] = newType;

                // Reset checkbox state when type changes
                if (!jobData.gear) jobData.gear = {};
                jobData.gear[slotId] = {};

                saveState();
                render();
            }

            // Utilities
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Handle job icon load error - show fallback text
            function handleJobIconError(img, jobId) {
                img.classList.add('hidden');
                // Create fallback element if it doesn't exist
                if (!img.nextElementSibling || !img.nextElementSibling.classList.contains('job-icon-fallback')) {
                    const fallback = document.createElement('span');
                    fallback.className = 'job-icon-fallback';
                    fallback.textContent = jobId;
                    img.parentNode.insertBefore(fallback, img.nextSibling);
                }
            }

            // Start the app
            init();
        })();
    </script>
</body>
</html>
