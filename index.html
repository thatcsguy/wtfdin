<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WTFDIN - WTF Do I Need?</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                /* Background layers - warm charcoal with subtle depth */
                --bg-primary: #1c1c24;
                --bg-secondary: #232330;
                --bg-tertiary: #2d2d3a;
                --bg-elevated: #363644;

                /* Text with good contrast */
                --text-primary: #f0f0f5;
                --text-secondary: #9898a8;
                --text-muted: #6b6b7a;

                /* Accent - warm amber/gold (FFXIV inspired) */
                --accent: #d4a855;
                --accent-hover: #e6bc6a;
                --accent-muted: rgba(212, 168, 85, 0.15);

                /* Semantic colors */
                --raid-color: #e85a71;
                --raid-bg: rgba(232, 90, 113, 0.12);
                --raid-bg-hover: rgba(232, 90, 113, 0.22);
                --tome-color: #5b9bd5;
                --tome-bg: rgba(91, 155, 213, 0.12);
                --tome-bg-hover: rgba(91, 155, 213, 0.22);
                --success-color: #5cb85c;
                --success-bg: rgba(92, 184, 92, 0.12);
                --warning-color: #f0ad4e;
                --warning-bg: rgba(240, 173, 78, 0.12);

                /* Borders and dividers */
                --border: #3a3a48;
                --border-subtle: #2f2f3c;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, sans-serif;
                background-color: var(--bg-primary);
                color: var(--text-primary);
                min-height: 100vh;
            }

            .app-container {
                display: flex;
                min-height: 100vh;
            }

            /* Sidebar */
            .sidebar {
                width: 280px;
                background-color: var(--bg-secondary);
                border-right: 1px solid var(--border);
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
            }

            .sidebar-header {
                padding: 24px 20px 20px;
                background: linear-gradient(
                    180deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border-bottom: 1px solid var(--border);
            }

            .sidebar-header h1 {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--accent);
                letter-spacing: 0.02em;
            }

            .sidebar-header p {
                font-size: 0.7rem;
                color: var(--text-muted);
                margin-top: 2px;
                text-transform: uppercase;
                letter-spacing: 0.08em;
            }

            .sidebar-actions {
                display: flex;
                gap: 8px;
                margin-top: 16px;
            }

            .btn-export {
                background-color: transparent;
                border: 1px solid var(--border);
                color: var(--text-secondary);
                flex: 1;
                font-size: 0.75rem;
            }

            .btn-export:hover {
                background-color: var(--bg-elevated);
                border-color: var(--accent);
                color: var(--accent);
            }

            .btn-export:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .character-list {
                flex: 1;
                overflow-y: auto;
                padding: 16px;
                display: flex;
                flex-direction: column;
            }

            .character-list-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border-subtle);
            }

            .character-list-header h2 {
                font-size: 0.7rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-weight: 600;
            }

            .character-count {
                font-size: 0.7rem;
                color: var(--text-muted);
                background: var(--bg-tertiary);
                padding: 2px 8px;
                border-radius: 10px;
            }

            .btn {
                background-color: var(--accent);
                color: var(--text-primary);
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.875rem;
                transition: background-color 0.2s;
            }

            .btn:hover {
                background-color: var(--accent-hover);
            }

            .btn:focus {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .btn:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .btn:focus:not(:focus-visible) {
                outline: none;
            }

            .btn-small {
                padding: 4px 8px;
                font-size: 0.75rem;
            }

            .character-list-container {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
            }

            .character-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px 12px;
                border-radius: 8px;
                cursor: pointer;
                margin-bottom: 4px;
                transition: all 0.15s ease;
                border: 1px solid transparent;
            }

            .character-item:hover {
                background-color: var(--bg-tertiary);
                border-color: var(--border-subtle);
            }

            .character-item:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: -2px;
                background-color: var(--bg-tertiary);
            }

            .character-item.selected {
                background-color: var(--accent-muted);
                border-color: var(--accent);
            }

            .character-item.selected .character-avatar {
                background: var(--accent);
                color: var(--bg-primary);
            }

            .character-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background: var(--bg-elevated);
                color: var(--text-secondary);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.875rem;
                font-weight: 600;
                flex-shrink: 0;
                transition: all 0.15s ease;
            }

            .character-item:hover .character-avatar {
                background: var(--bg-elevated);
                color: var(--accent);
            }

            .character-item-content {
                flex: 1;
                min-width: 0;
                transition: margin-right 0.15s ease;
            }

            .character-item:hover .character-item-content,
            .character-item:focus-within .character-item-content {
                margin-right: 8px;
            }

            .character-item .name {
                font-weight: 500;
                font-size: 0.9rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: block;
            }

            .character-item-actions {
                display: flex;
                gap: 4px;
                flex-shrink: 0;
                max-width: 0;
                opacity: 0;
                overflow: hidden;
                transition:
                    opacity 0.15s ease,
                    max-width 0.15s ease;
            }

            .character-item:hover .character-item-actions,
            .character-item:focus-within .character-item-actions {
                opacity: 1;
                max-width: 150px;
            }

            .character-item-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .btn-delete {
                background-color: transparent;
                color: var(--text-muted);
                padding: 4px 6px;
                font-size: 0.7rem;
                border: 1px solid transparent;
                border-radius: 4px;
            }

            .btn-delete:hover {
                background-color: var(--raid-bg);
                color: var(--raid-color);
                border-color: var(--raid-color);
            }

            .btn-delete:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .btn-rename {
                background-color: transparent;
                color: var(--text-muted);
                padding: 4px 6px;
                font-size: 0.7rem;
                border: 1px solid transparent;
                border-radius: 4px;
            }

            .btn-rename:hover {
                background-color: var(--tome-bg);
                color: var(--tome-color);
                border-color: var(--tome-color);
            }

            .btn-rename:focus-visible {
                outline: 2px solid var(--tome-color);
                outline-offset: 2px;
            }

            .no-characters {
                color: var(--text-muted);
                font-size: 0.8rem;
                text-align: center;
                padding: 32px 16px;
                background: var(--bg-tertiary);
                border-radius: 8px;
                border: 1px dashed var(--border);
            }

            .sidebar-footer {
                padding: 16px;
                border-top: 1px solid var(--border);
                background: var(--bg-secondary);
            }

            .btn-add-character {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 12px 16px;
                font-size: 0.875rem;
                font-weight: 500;
            }

            .btn-add-character::before {
                content: "+";
                font-size: 1.1rem;
                font-weight: 400;
            }

            /* Main Panel */
            .main-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .main-header {
                padding: 24px 28px 20px;
                background: linear-gradient(
                    180deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border-bottom: 1px solid var(--border);
            }

            .main-header h2 {
                font-size: 1.75rem;
                font-weight: 600;
                color: var(--text-primary);
                letter-spacing: -0.01em;
                margin-bottom: 4px;
            }

            .character-subtitle {
                font-size: 0.75rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.08em;
            }

            .main-content {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
            }

            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: var(--text-secondary);
            }

            .empty-state p {
                margin-bottom: 16px;
            }

            /* Job Section */
            .job-section {
                margin-bottom: 20px;
            }

            .job-section-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border-subtle);
            }

            .job-section-title {
                font-size: 0.7rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-weight: 600;
            }

            .job-count {
                font-size: 0.7rem;
                color: var(--text-muted);
                background: var(--bg-tertiary);
                padding: 2px 8px;
                border-radius: 10px;
            }

            /* Job Pills */
            .job-pills {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
            }

            .job-pill {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px 14px 8px 10px;
                background: linear-gradient(
                    135deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border: 1px solid var(--border);
                border-radius: 24px;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            }

            .job-pill:hover {
                background: linear-gradient(
                    135deg,
                    var(--bg-elevated) 0%,
                    var(--bg-tertiary) 100%
                );
                border-color: var(--text-muted);
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            .job-pill:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
                background: linear-gradient(
                    135deg,
                    var(--bg-elevated) 0%,
                    var(--bg-tertiary) 100%
                );
            }

            .job-pill.selected {
                background: linear-gradient(
                    135deg,
                    var(--accent-muted) 0%,
                    rgba(212, 168, 85, 0.08) 100%
                );
                border-color: var(--accent);
                box-shadow:
                    0 2px 8px rgba(212, 168, 85, 0.2),
                    inset 0 1px 0 rgba(212, 168, 85, 0.1);
            }

            .job-pill.selected:hover {
                background: linear-gradient(
                    135deg,
                    rgba(212, 168, 85, 0.2) 0%,
                    rgba(212, 168, 85, 0.1) 100%
                );
            }

            .job-pill-icon {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                background: var(--bg-primary);
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                flex-shrink: 0;
            }

            .job-pill img {
                width: 22px;
                height: 22px;
            }

            .job-pill img.hidden {
                display: none;
            }

            .job-pill .job-icon-fallback {
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: var(--bg-primary);
                border-radius: 50%;
                font-size: 0.625rem;
                font-weight: 600;
                color: var(--text-secondary);
            }

            .job-pill-name {
                font-size: 0.875rem;
                font-weight: 500;
                color: var(--text-primary);
            }

            .job-pill.selected .job-pill-name {
                color: var(--accent);
            }

            .job-pill .job-remove-btn {
                display: none;
                align-items: center;
                justify-content: center;
                width: 20px;
                height: 20px;
                margin-left: 2px;
                background-color: transparent;
                border: 1px solid var(--raid-color);
                border-radius: 50%;
                color: var(--raid-color);
                font-size: 14px;
                line-height: 1;
                cursor: pointer;
                transition: all 0.15s ease;
                opacity: 0.7;
            }

            .job-pill:hover .job-remove-btn {
                display: flex;
            }

            .job-pill .job-remove-btn:hover {
                background-color: var(--raid-color);
                border-color: var(--raid-color);
                color: var(--text-primary);
                opacity: 1;
            }

            .job-pill .job-remove-btn:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 1px;
            }

            /* Add Job Button - pill style */
            .btn-add-job {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 8px 16px;
                background: transparent;
                border: 1px dashed var(--border);
                border-radius: 24px;
                color: var(--text-muted);
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .btn-add-job:hover {
                border-color: var(--accent);
                border-style: solid;
                color: var(--accent);
                background: var(--accent-muted);
            }

            .btn-add-job:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .btn-add-job::before {
                content: "+";
                font-size: 1rem;
                font-weight: 400;
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.75);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                backdrop-filter: blur(4px);
            }

            .modal-overlay.hidden {
                display: none;
            }

            .modal {
                background-color: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 0;
                max-width: 560px;
                max-height: 85vh;
                overflow: hidden;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            }

            .modal-header {
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 20px 24px;
                background: linear-gradient(
                    135deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border-bottom: 1px solid var(--border);
            }

            .modal-header-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                background: var(--bg-primary);
                border: 2px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                flex-shrink: 0;
            }

            .modal-header-icon.accent {
                color: var(--accent);
            }

            .modal-header-icon.danger {
                background: var(--raid-bg);
                border-color: rgba(232, 90, 113, 0.3);
                color: var(--raid-color);
            }

            .modal-header-content h3 {
                margin: 0;
                font-size: 1.125rem;
                color: var(--text-primary);
                font-weight: 600;
            }

            .modal-header-content p {
                margin: 4px 0 0;
                font-size: 0.8rem;
                color: var(--text-muted);
            }

            .modal h3 {
                margin-bottom: 16px;
                color: var(--accent);
            }

            .modal-body {
                padding: 20px 24px;
                max-height: 60vh;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 16px 24px;
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                border-top: 1px solid var(--border-subtle);
                background: var(--bg-secondary);
            }

            /* Job Selection Modal */
            .modal-job-select {
                max-width: 640px;
            }

            .job-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 10px;
            }

            .job-grid-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 14px 8px 12px;
                background: linear-gradient(
                    135deg,
                    var(--bg-primary) 0%,
                    rgba(28, 28, 36, 0.8) 100%
                );
                border: 2px solid var(--border);
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            }

            .job-grid-item:hover {
                background: linear-gradient(
                    135deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border-color: var(--accent);
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            }

            .job-grid-item:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
                background: linear-gradient(
                    135deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
            }

            .job-grid-item.disabled {
                opacity: 0.35;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            .job-grid-item.disabled:hover {
                border-color: var(--border);
                transform: none;
                box-shadow: none;
            }

            .job-grid-item-icon {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                background: var(--bg-secondary);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 8px;
                border: 1px solid var(--border-subtle);
            }

            .job-grid-item img {
                width: 36px;
                height: 36px;
            }

            .job-grid-item img.hidden {
                display: none;
            }

            .job-grid-item .job-icon-fallback {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: var(--bg-tertiary);
                border-radius: 50%;
                font-size: 0.75rem;
                font-weight: 600;
                color: var(--text-secondary);
            }

            .job-grid-item span {
                font-size: 0.7rem;
                font-weight: 500;
                text-align: center;
                color: var(--text-secondary);
                transition: color 0.2s ease;
            }

            .job-grid-item:hover span {
                color: var(--text-primary);
            }

            .job-category {
                margin-bottom: 20px;
            }

            .job-category:last-child {
                margin-bottom: 0;
            }

            .job-category-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 1px solid var(--border-subtle);
            }

            .job-category-icon {
                width: 24px;
                height: 24px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.75rem;
            }

            .job-category-icon.tanks {
                background: rgba(91, 155, 213, 0.15);
                color: var(--tome-color);
            }

            .job-category-icon.healers {
                background: rgba(92, 184, 92, 0.15);
                color: var(--success-color);
            }

            .job-category-icon.melee {
                background: rgba(232, 90, 113, 0.15);
                color: var(--raid-color);
            }

            .job-category-icon.ranged {
                background: rgba(240, 173, 78, 0.15);
                color: var(--warning-color);
            }

            .job-category-icon.casters {
                background: rgba(212, 168, 85, 0.15);
                color: var(--accent);
            }

            .job-category h4 {
                font-size: 0.75rem;
                color: var(--text-secondary);
                margin: 0;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                font-weight: 600;
            }

            .modal-close {
                margin-top: 16px;
                width: 100%;
            }

            .modal-small {
                max-width: 420px;
            }

            .modal-input {
                width: 100%;
                padding: 14px 16px;
                background-color: var(--bg-primary);
                border: 2px solid var(--border);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 1rem;
                margin-bottom: 8px;
                transition: border-color 0.2s ease;
            }

            .modal-input:focus {
                outline: none;
                border-color: var(--accent);
            }

            .modal-input::placeholder {
                color: var(--text-muted);
            }

            .modal-buttons {
                display: flex;
                gap: 12px;
                justify-content: flex-end;
            }

            .btn-secondary {
                background-color: var(--bg-tertiary);
                border: 1px solid var(--border);
            }

            .btn-secondary:hover {
                background-color: var(--bg-elevated);
                border-color: var(--text-muted);
            }

            .btn-danger {
                background-color: var(--raid-color);
                border: none;
            }

            .btn-danger:hover {
                background-color: #d14a5f;
            }

            /* Delete Confirmation Modal */
            .modal-confirm {
                max-width: 400px;
            }

            .confirm-message {
                color: var(--text-secondary);
                line-height: 1.6;
                font-size: 0.95rem;
            }

            .confirm-message strong {
                color: var(--text-primary);
                font-weight: 600;
            }

            .confirm-warning {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 14px 16px;
                background: var(--raid-bg);
                border: 1px solid rgba(232, 90, 113, 0.25);
                border-radius: 8px;
                margin-top: 16px;
            }

            .confirm-warning-icon {
                font-size: 1rem;
                color: var(--raid-color);
                flex-shrink: 0;
                margin-top: 1px;
            }

            .confirm-warning-text {
                font-size: 0.8rem;
                color: var(--raid-color);
                line-height: 1.5;
            }

            .modal-message {
                color: var(--text-secondary);
                margin-bottom: 20px;
                line-height: 1.5;
            }

            .bis-config-step {
                display: none;
            }

            .bis-config-step.active {
                display: block;
            }

            .bis-option-buttons {
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
            }

            .bis-option-btn {
                flex: 1;
                padding: 16px;
                background-color: var(--bg-primary);
                border: 2px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
                text-align: center;
                transition: all 0.2s;
            }

            .bis-option-btn:hover {
                border-color: var(--accent);
                background-color: var(--bg-tertiary);
            }

            .bis-option-btn:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .bis-option-btn h4 {
                color: var(--text-primary);
                margin-bottom: 4px;
                font-size: 1rem;
            }

            .bis-option-btn p {
                color: var(--text-secondary);
                font-size: 0.75rem;
                margin: 0;
            }

            .bis-slot-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: repeat(6, auto);
                gap: 8px;
                margin-top: 16px;
            }

            /* Left column: Weapon, Head, Body, Hands, Legs, Feet */
            .bis-slot-item[data-slot="weapon"] {
                grid-row: 1;
                grid-column: 1;
            }
            .bis-slot-item[data-slot="head"] {
                grid-row: 2;
                grid-column: 1;
            }
            .bis-slot-item[data-slot="body"] {
                grid-row: 3;
                grid-column: 1;
            }
            .bis-slot-item[data-slot="hands"] {
                grid-row: 4;
                grid-column: 1;
            }
            .bis-slot-item[data-slot="legs"] {
                grid-row: 5;
                grid-column: 1;
            }
            .bis-slot-item[data-slot="feet"] {
                grid-row: 6;
                grid-column: 1;
            }

            /* Right column: Earrings, Necklace, Bracelets, Ring 1, Ring 2 */
            .bis-slot-item[data-slot="earrings"] {
                grid-row: 1;
                grid-column: 2;
            }
            .bis-slot-item[data-slot="necklace"] {
                grid-row: 2;
                grid-column: 2;
            }
            .bis-slot-item[data-slot="bracelets"] {
                grid-row: 3;
                grid-column: 2;
            }
            .bis-slot-item[data-slot="ring1"] {
                grid-row: 4;
                grid-column: 2;
            }
            .bis-slot-item[data-slot="ring2"] {
                grid-row: 5;
                grid-column: 2;
            }

            .bis-slot-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 12px;
                background-color: var(--bg-primary);
                border: 1px solid var(--border);
                border-radius: 6px;
            }

            .bis-slot-item .slot-name {
                font-size: 0.875rem;
            }

            .bis-slot-toggle {
                display: flex;
                gap: 4px;
            }

            .bis-slot-toggle button {
                padding: 4px 8px;
                font-size: 0.7rem;
                border: 1px solid var(--border);
                border-radius: 4px;
                cursor: pointer;
                background-color: var(--bg-secondary);
                color: var(--text-secondary);
                transition: all 0.2s;
            }

            .bis-slot-toggle button.active {
                background-color: var(--accent);
                border-color: var(--accent);
                color: var(--text-primary);
            }

            .bis-slot-toggle button:hover:not(.active) {
                background-color: var(--bg-tertiary);
            }

            .modal-back-btn {
                margin-right: auto;
            }

            /* Slot Config Modal */
            .modal-slot-config {
                max-width: 420px;
                padding: 0;
                overflow: hidden;
            }

            .slot-config-header {
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 20px 24px;
                background: linear-gradient(
                    135deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border-bottom: 1px solid var(--border);
            }

            .slot-config-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                background: var(--bg-primary);
                border: 2px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                color: var(--accent);
            }

            .slot-config-title-group h3 {
                margin: 0;
                font-size: 1.125rem;
                color: var(--text-primary);
            }

            .slot-config-subtitle {
                margin: 4px 0 0;
                font-size: 0.8rem;
                color: var(--text-muted);
            }

            .slot-config-options {
                padding: 16px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .slot-config-option {
                display: flex;
                align-items: stretch;
                gap: 0;
                padding: 0;
                background: var(--bg-primary);
                border: 2px solid var(--border);
                border-radius: 10px;
                cursor: pointer;
                text-align: left;
                transition: all 0.2s ease;
                overflow: hidden;
            }

            .slot-config-option:hover {
                border-color: var(--text-muted);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            .slot-config-option:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .slot-config-option.selected {
                border-color: var(--accent);
                background: var(--accent-muted);
            }

            .slot-config-option.selected[data-type="raid"] {
                border-color: var(--raid-color);
                background: var(--raid-bg);
            }

            .slot-config-option.selected[data-type="tome"] {
                border-color: var(--tome-color);
                background: var(--tome-bg);
            }

            .slot-config-option-indicator {
                width: 4px;
                background: transparent;
                transition: background 0.2s ease;
            }

            .slot-config-option.selected[data-type="raid"]
                .slot-config-option-indicator {
                background: var(--raid-color);
            }

            .slot-config-option.selected[data-type="tome"]
                .slot-config-option-indicator {
                background: var(--tome-color);
            }

            .slot-config-option-content {
                flex: 1;
                padding: 14px 16px;
            }

            .slot-config-option-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 6px;
            }

            .slot-config-option-badge {
                display: inline-flex;
                align-items: center;
                padding: 3px 10px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.03em;
            }

            .slot-config-option-badge.raid {
                background: var(--raid-bg);
                color: var(--raid-color);
                border: 1px solid rgba(232, 90, 113, 0.3);
            }

            .slot-config-option-badge.tome {
                background: var(--tome-bg);
                color: var(--tome-color);
                border: 1px solid rgba(91, 155, 213, 0.3);
            }

            .slot-config-option-turn,
            .slot-config-option-cost {
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            .slot-config-option-desc {
                font-size: 0.8rem;
                color: var(--text-secondary);
                margin: 0;
                line-height: 1.4;
            }

            .slot-config-footer {
                padding: 12px 16px 16px;
                display: flex;
                justify-content: flex-end;
                border-top: 1px solid var(--border-subtle);
            }

            .no-jobs {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .job-info {
                margin-top: 24px;
                padding-top: 20px;
                border-top: 1px solid var(--border);
            }

            .job-info h3 {
                margin-bottom: 12px;
                color: var(--accent);
            }

            /* Gear Table - Two column layout with separate tables */
            .gear-table-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-top: 16px;
            }

            .gear-table-column {
                display: flex;
                flex-direction: column;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 12px;
                overflow: hidden;
            }

            .gear-table-column-header {
                padding: 14px 16px;
                color: var(--text-primary);
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                font-weight: 600;
                background: linear-gradient(
                    180deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border-bottom: 1px solid var(--border);
            }

            .gear-table-row {
                display: grid;
                grid-template-columns: 90px 60px 90px 1fr;
                border-bottom: 1px solid var(--border-subtle);
                transition: background-color 0.15s ease;
                position: relative;
            }

            .gear-table-row:last-child {
                border-bottom: none;
            }

            .gear-table-row:hover {
                background-color: var(--bg-tertiary);
            }

            .gear-table-cell {
                padding: 14px 12px;
                font-size: 0.875rem;
                display: flex;
                align-items: center;
            }

            .gear-table-cell:first-child {
                padding-left: 16px;
            }

            .slot-name {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 0.85rem;
            }

            .slot-type {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 4px 10px;
                border-radius: 6px;
                font-size: 0.7rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                text-transform: uppercase;
                letter-spacing: 0.03em;
                border: 1px solid transparent;
            }

            .slot-type:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }

            .slot-type:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .slot-type.raid {
                background-color: var(--raid-bg);
                color: var(--raid-color);
                border-color: rgba(232, 90, 113, 0.3);
            }

            .slot-type.raid:hover {
                background-color: var(--raid-bg-hover);
                border-color: var(--raid-color);
            }

            .slot-type.tome {
                background-color: var(--tome-bg);
                color: var(--tome-color);
                border-color: rgba(91, 155, 213, 0.3);
            }

            .slot-type.tome:hover {
                background-color: var(--tome-bg-hover);
                border-color: var(--tome-color);
            }

            .turn-label {
                font-size: 0.7rem;
                color: var(--text-muted);
                font-weight: 500;
            }

            .tome-cost {
                font-size: 0.7rem;
                color: var(--text-muted);
                font-weight: 500;
            }

            .tome-cost::after {
                content: " tomes";
            }

            .gear-checkbox-group {
                display: flex;
                gap: 12px;
            }

            .gear-checkbox-label {
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                font-size: 0.8rem;
                color: var(--text-secondary);
                padding: 6px 10px;
                border-radius: 6px;
                transition: all 0.15s ease;
                border: 1px solid transparent;
            }

            .gear-checkbox-label:hover {
                background-color: var(--bg-elevated);
                color: var(--text-primary);
            }

            .gear-checkbox-label input[type="checkbox"] {
                appearance: none;
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                border: 2px solid var(--border);
                border-radius: 4px;
                background: var(--bg-primary);
                cursor: pointer;
                transition: all 0.15s ease;
                position: relative;
                flex-shrink: 0;
            }

            .gear-checkbox-label input[type="checkbox"]:hover {
                border-color: var(--accent);
            }

            .gear-checkbox-label input[type="checkbox"]:checked {
                background: var(--accent);
                border-color: var(--accent);
            }

            .gear-checkbox-label input[type="checkbox"]:checked::after {
                content: "";
                position: absolute;
                left: 50%;
                top: 50%;
                width: 5px;
                height: 10px;
                border: solid var(--bg-primary);
                border-width: 0 2px 2px 0;
                transform: translate(-50%, -60%) rotate(45deg);
            }

            .gear-checkbox-label input[type="checkbox"]:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .gear-checkbox-label.checked {
                color: var(--text-primary);
            }

            /* Slot completion states */
            .gear-table-row.slot-complete {
                background: linear-gradient(
                    90deg,
                    rgba(92, 184, 92, 0.15) 0%,
                    rgba(92, 184, 92, 0.08) 100%
                );
            }

            .gear-table-row.slot-complete::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 3px;
                background: var(--success-color);
            }

            .gear-table-row.slot-complete:hover {
                background: linear-gradient(
                    90deg,
                    rgba(92, 184, 92, 0.22) 0%,
                    rgba(92, 184, 92, 0.12) 100%
                );
            }

            .gear-table-row.slot-partial {
                background: linear-gradient(
                    90deg,
                    rgba(240, 173, 78, 0.15) 0%,
                    rgba(240, 173, 78, 0.08) 100%
                );
            }

            .gear-table-row.slot-partial::before {
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 3px;
                background: var(--warning-color);
            }

            .gear-table-row.slot-partial:hover {
                background: linear-gradient(
                    90deg,
                    rgba(240, 173, 78, 0.22) 0%,
                    rgba(240, 173, 78, 0.12) 100%
                );
            }

            /* Progress indicator */
            .progress-container {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
            }

            .progress-bar {
                flex: 1;
                height: 8px;
                background-color: var(--bg-primary);
                border-radius: 4px;
                overflow: hidden;
            }

            .progress-bar-fill {
                height: 100%;
                background-color: var(--success-color);
                transition: width 0.3s ease;
            }

            .progress-text {
                font-size: 0.875rem;
                color: var(--text-secondary);
                white-space: nowrap;
            }

            .progress-text.complete {
                color: var(--success-color);
                font-weight: 500;
            }

            /* Summary Panel */
            .gear-layout {
                display: flex;
                gap: 24px;
                align-items: flex-start;
            }

            .gear-table-container {
                flex: 1;
                min-width: 0;
            }

            .summary-panel {
                width: 260px;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .summary-panel h4 {
                display: none;
            }

            /* Summary cards - matching gear table card style */
            .summary-section {
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 12px;
                overflow: hidden;
            }

            .summary-section-header {
                padding: 14px 16px;
                display: flex;
                align-items: center;
                gap: 10px;
                border-bottom: 1px solid var(--border);
            }

            .summary-section-icon {
                width: 32px;
                height: 32px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1rem;
                flex-shrink: 0;
            }

            .summary-section-title {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                font-weight: 600;
            }

            .summary-section-body {
                padding: 0;
            }

            /* Raid section styling */
            .summary-section.raid-section .summary-section-header {
                background: linear-gradient(
                    180deg,
                    rgba(232, 90, 113, 0.15) 0%,
                    rgba(232, 90, 113, 0.05) 100%
                );
            }

            .summary-section.raid-section .summary-section-icon {
                background: var(--raid-bg);
                color: var(--raid-color);
                border: 1px solid rgba(232, 90, 113, 0.3);
            }

            .summary-section.raid-section .summary-section-title {
                color: var(--raid-color);
            }

            /* Tome section styling */
            .summary-section.tome-section .summary-section-header {
                background: linear-gradient(
                    180deg,
                    rgba(91, 155, 213, 0.15) 0%,
                    rgba(91, 155, 213, 0.05) 100%
                );
            }

            .summary-section.tome-section .summary-section-icon {
                background: var(--tome-bg);
                color: var(--tome-color);
                border: 1px solid rgba(91, 155, 213, 0.3);
            }

            .summary-section.tome-section .summary-section-title {
                color: var(--tome-color);
            }

            /* Summary items */
            .summary-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 16px;
                border-bottom: 1px solid var(--border-subtle);
                transition: background-color 0.15s ease;
            }

            .summary-item:last-child {
                border-bottom: none;
            }

            .summary-item:hover {
                background-color: var(--bg-tertiary);
            }

            .summary-item-label {
                font-size: 0.875rem;
                color: var(--text-primary);
                font-weight: 500;
            }

            .summary-item-value {
                font-size: 0.9rem;
                font-weight: 700;
                font-variant-numeric: tabular-nums;
            }

            .summary-section.raid-section .summary-item-value {
                color: var(--raid-color);
            }

            .summary-section.tome-section .summary-item-value {
                color: var(--tome-color);
            }

            .summary-item-value.zero {
                color: var(--success-color);
            }

            /* Empty state */
            .summary-empty {
                padding: 20px 16px;
                text-align: center;
            }

            .summary-empty-icon {
                font-size: 1.5rem;
                margin-bottom: 8px;
                opacity: 0.7;
            }

            .summary-empty-text {
                color: var(--text-secondary);
                font-size: 0.8rem;
            }

            /* Total row styling */
            .summary-total {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 14px 16px;
                background: linear-gradient(
                    180deg,
                    var(--bg-tertiary) 0%,
                    var(--bg-secondary) 100%
                );
                border-top: 1px solid var(--border);
            }

            .summary-total-label {
                font-size: 0.75rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .summary-total-value {
                font-size: 1.1rem;
                font-weight: 700;
                font-variant-numeric: tabular-nums;
            }

            .summary-section.tome-section .summary-total-value {
                color: var(--tome-color);
            }

            /* Responsive */
            @media (max-width: 768px) {
                .app-container {
                    flex-direction: column;
                }

                .sidebar {
                    width: 100%;
                    border-right: none;
                    border-bottom: 1px solid var(--border);
                    max-height: 40vh;
                }

                .sidebar-header {
                    padding: 12px 16px;
                    background: var(--bg-secondary);
                }

                .sidebar-header h1 {
                    font-size: 1.2rem;
                }

                .sidebar-header p {
                    display: none;
                }

                .sidebar-actions {
                    margin-top: 10px;
                }

                .character-list {
                    padding: 8px 12px;
                }

                .character-list-header {
                    margin-bottom: 8px;
                    padding-bottom: 8px;
                }

                .sidebar-footer {
                    padding: 12px;
                }

                .btn-add-character {
                    padding: 10px 14px;
                }

                /* Tap-friendly buttons - minimum 44px touch target */
                .btn {
                    min-height: 44px;
                    padding: 10px 16px;
                    font-size: 0.875rem;
                }

                .btn-small {
                    min-height: 44px;
                    padding: 10px 12px;
                }

                /* Character item tap-friendly */
                .character-item {
                    padding: 12px 10px;
                    min-height: 52px;
                }

                .character-avatar {
                    width: 32px;
                    height: 32px;
                    font-size: 0.75rem;
                }

                /* Always show character actions on mobile */
                .character-item-actions {
                    opacity: 1;
                }

                .btn-delete,
                .btn-rename {
                    min-height: 36px;
                    padding: 8px 10px;
                }

                /* Main panel */
                .main-header {
                    padding: 12px 16px;
                }

                .main-header h2 {
                    font-size: 1.25rem;
                }

                .main-content {
                    padding: 12px 16px;
                }

                /* Job pills tap-friendly */
                .job-pill {
                    padding: 10px 14px 10px 10px;
                    min-height: 44px;
                }

                .job-pill .job-remove-btn {
                    display: flex;
                    width: 24px;
                    height: 24px;
                }

                .btn-add-job {
                    padding: 10px 16px;
                    min-height: 44px;
                }

                /* Gear table mobile layout */
                .gear-table-grid {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }

                .gear-table-column {
                    border-radius: 10px;
                }

                .gear-table-row {
                    grid-template-columns: 70px 54px 75px 1fr;
                }

                .gear-table-cell {
                    padding: 12px 8px;
                }

                .gear-table-cell:first-child {
                    padding-left: 12px;
                }

                .slot-name {
                    font-size: 0.75rem;
                }

                .slot-type {
                    padding: 3px 8px;
                    font-size: 0.6rem;
                }

                .turn-label,
                .tome-cost {
                    font-size: 0.6rem;
                }

                /* Stack checkboxes vertically on mobile */
                .gear-checkbox-group {
                    flex-direction: column;
                    gap: 4px;
                }

                .gear-checkbox-label {
                    min-height: 44px;
                    display: flex;
                    align-items: center;
                    padding: 8px 6px;
                    font-size: 0.75rem;
                }

                .gear-checkbox-label input[type="checkbox"] {
                    width: 24px;
                    height: 24px;
                }

                .gear-checkbox-label input[type="checkbox"]:checked::after {
                    left: 50%;
                    top: 50%;
                    width: 6px;
                    height: 12px;
                    transform: translate(-50%, -60%) rotate(45deg);
                }

                /* Progress bar */
                .progress-container {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 8px;
                }

                .progress-text {
                    text-align: center;
                }

                /* Summary panel mobile */
                .gear-layout {
                    flex-direction: column;
                }

                .summary-panel {
                    width: 100%;
                    order: -1; /* Show summary above table on mobile */
                    margin-bottom: 16px;
                    flex-direction: row;
                }

                .summary-section {
                    flex: 1;
                }

                .summary-section-header {
                    padding: 12px 14px;
                }

                .summary-section-icon {
                    width: 28px;
                    height: 28px;
                    font-size: 0.875rem;
                }

                .summary-item {
                    padding: 10px 14px;
                }

                .summary-total {
                    padding: 12px 14px;
                }

                /* Modal mobile */
                .modal {
                    width: 95%;
                    max-height: 90vh;
                }

                .modal-header {
                    padding: 16px 18px;
                    gap: 12px;
                }

                .modal-header-icon {
                    width: 40px;
                    height: 40px;
                    font-size: 1rem;
                }

                .modal-header-content h3 {
                    font-size: 1rem;
                }

                .modal-body {
                    padding: 16px 18px;
                }

                .modal-footer {
                    padding: 14px 18px;
                }

                .job-grid {
                    grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
                    gap: 8px;
                }

                .job-grid-item {
                    padding: 10px 6px 8px;
                }

                .job-grid-item-icon {
                    width: 38px;
                    height: 38px;
                    margin-bottom: 6px;
                }

                .job-grid-item img {
                    width: 30px;
                    height: 30px;
                }

                .job-grid-item .job-icon-fallback {
                    width: 30px;
                    height: 30px;
                    font-size: 0.7rem;
                }

                .job-category-header {
                    margin-bottom: 10px;
                    padding-bottom: 6px;
                }

                .confirm-warning {
                    padding: 12px 14px;
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h1>WTFDIN</h1>
                    <p>WTF Do I Need?</p>
                    <div class="sidebar-actions">
                        <button
                            class="btn btn-small btn-export"
                            id="export-btn"
                        >
                            Export URL
                        </button>
                    </div>
                </div>
                <div class="character-list">
                    <div class="character-list-header">
                        <h2>Characters</h2>
                        <span class="character-count" id="character-count"
                            >0</span
                        >
                    </div>
                    <div
                        class="character-list-container"
                        id="character-list-container"
                    >
                        <p class="no-characters">
                            No characters yet.<br />Add one to get started!
                        </p>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button
                        class="btn btn-add-character"
                        id="add-character-btn"
                    >
                        Add Character
                    </button>
                </div>
            </aside>
            <main class="main-panel">
                <div class="main-header">
                    <h2 id="character-name">Select a Character</h2>
                    <p class="character-subtitle" id="character-subtitle"></p>
                </div>
                <div class="main-content">
                    <div class="empty-state" id="empty-state">
                        <p>
                            Select a character from the sidebar to view their
                            gear progress.
                        </p>
                    </div>
                    <div id="character-details" style="display: none">
                        <!-- Character details will be rendered here -->
                    </div>
                </div>
            </main>
        </div>

        <!-- Job Picker Modal -->
        <div class="modal-overlay hidden" id="job-modal">
            <div class="modal modal-job-select">
                <div class="modal-header">
                    <div class="modal-header-icon accent" id="job-modal-icon">
                        +
                    </div>
                    <div class="modal-header-content">
                        <h3 id="job-modal-title">Add Job</h3>
                        <p id="job-modal-subtitle">
                            Select a job to track gear for
                        </p>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="job-modal-step1" class="bis-config-step active">
                        <div id="job-modal-content"></div>
                    </div>
                    <div id="job-modal-step2" class="bis-config-step">
                        <div id="bis-config-content"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        class="btn btn-secondary modal-back-btn hidden"
                        id="job-modal-back"
                    >
                        Back
                    </button>
                    <button class="btn btn-secondary" id="job-modal-close">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Modal (Rename/Add Character) -->
        <div class="modal-overlay hidden" id="input-modal">
            <div class="modal modal-small">
                <div class="modal-header">
                    <div class="modal-header-icon accent" id="input-modal-icon">
                        
                    </div>
                    <div class="modal-header-content">
                        <h3 id="input-modal-title">Enter Name</h3>
                        <p id="input-modal-subtitle">
                            Choose a name for your character
                        </p>
                    </div>
                </div>
                <div class="modal-body">
                    <input
                        type="text"
                        id="input-modal-field"
                        class="modal-input"
                        placeholder="Enter name..."
                    />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="input-modal-cancel">
                        Cancel
                    </button>
                    <button class="btn" id="input-modal-confirm">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirm Modal (Delete/Remove) -->
        <div class="modal-overlay hidden" id="confirm-modal">
            <div class="modal modal-small modal-confirm">
                <div class="modal-header">
                    <div
                        class="modal-header-icon danger"
                        id="confirm-modal-icon"
                    >
                        
                    </div>
                    <div class="modal-header-content">
                        <h3 id="confirm-modal-title">Confirm Delete</h3>
                        <p id="confirm-modal-subtitle">
                            This action cannot be undone
                        </p>
                    </div>
                </div>
                <div class="modal-body">
                    <p id="confirm-modal-message" class="confirm-message"></p>
                    <div class="confirm-warning">
                        <span class="confirm-warning-icon"></span>
                        <span class="confirm-warning-text"
                            >All associated data will be permanently
                            removed.</span
                        >
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="confirm-modal-cancel">
                        Cancel
                    </button>
                    <button class="btn btn-danger" id="confirm-modal-confirm">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Slot Config Modal -->
        <div class="modal-overlay hidden" id="slot-config-modal">
            <div class="modal modal-slot-config">
                <div class="slot-config-header">
                    <div class="slot-config-icon" id="slot-config-icon"></div>
                    <div class="slot-config-title-group">
                        <h3 id="slot-config-title">Configure Head</h3>
                        <p
                            id="slot-config-subtitle"
                            class="slot-config-subtitle"
                        >
                            Choose how to obtain this gear
                        </p>
                    </div>
                </div>
                <div class="slot-config-options">
                    <button
                        class="slot-config-option"
                        data-type="raid"
                        id="slot-config-raid"
                    >
                        <div class="slot-config-option-indicator"></div>
                        <div class="slot-config-option-content">
                            <div class="slot-config-option-header">
                                <span class="slot-config-option-badge raid"
                                    >Raid</span
                                >
                                <span
                                    class="slot-config-option-turn"
                                    id="slot-config-raid-turn"
                                    >2nd Turn</span
                                >
                            </div>
                            <p class="slot-config-option-desc">
                                Drop from Savage raid. Track when you obtain the
                                coffer.
                            </p>
                        </div>
                    </button>
                    <button
                        class="slot-config-option"
                        data-type="tome"
                        id="slot-config-tome"
                    >
                        <div class="slot-config-option-indicator"></div>
                        <div class="slot-config-option-content">
                            <div class="slot-config-option-header">
                                <span class="slot-config-option-badge tome"
                                    >Tome</span
                                >
                                <span
                                    class="slot-config-option-cost"
                                    id="slot-config-tome-cost"
                                    >495 tomes</span
                                >
                            </div>
                            <p class="slot-config-option-desc">
                                Purchase with tomestones. Track base and
                                upgraded status.
                            </p>
                        </div>
                    </button>
                </div>
                <div class="slot-config-footer">
                    <button class="btn btn-secondary" id="slot-config-cancel">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <script>
            // WTFDIN - WTF Do I Need?
            // Vanilla JS FFXIV Gear Tracker

            (function () {
                "use strict";

                // FFXIV Job Data with XIVAPI icons
                const JOBS = {
                    tanks: [
                        {
                            id: "PLD",
                            name: "Paladin",
                            icon: "icons/paladin.png",
                        },
                        {
                            id: "WAR",
                            name: "Warrior",
                            icon: "icons/warrior.png",
                        },
                        {
                            id: "DRK",
                            name: "Dark Knight",
                            icon: "icons/darkknight.png",
                        },
                        {
                            id: "GNB",
                            name: "Gunbreaker",
                            icon: "icons/gunbreaker.png",
                        },
                    ],
                    healers: [
                        {
                            id: "WHM",
                            name: "White Mage",
                            icon: "icons/whitemage.png",
                        },
                        {
                            id: "SCH",
                            name: "Scholar",
                            icon: "icons/scholar.png",
                        },
                        {
                            id: "AST",
                            name: "Astrologian",
                            icon: "icons/astrologian.png",
                        },
                        { id: "SGE", name: "Sage", icon: "icons/sage.png" },
                    ],
                    melee: [
                        { id: "MNK", name: "Monk", icon: "icons/monk.png" },
                        {
                            id: "DRG",
                            name: "Dragoon",
                            icon: "icons/dragoon.png",
                        },
                        { id: "NIN", name: "Ninja", icon: "icons/ninja.png" },
                        {
                            id: "SAM",
                            name: "Samurai",
                            icon: "icons/samurai.png",
                        },
                        { id: "RPR", name: "Reaper", icon: "icons/reaper.png" },
                        { id: "VPR", name: "Viper", icon: "icons/viper.png" },
                    ],
                    ranged: [
                        { id: "BRD", name: "Bard", icon: "icons/bard.png" },
                        {
                            id: "MCH",
                            name: "Machinist",
                            icon: "icons/machinist.png",
                        },
                        { id: "DNC", name: "Dancer", icon: "icons/dancer.png" },
                    ],
                    casters: [
                        {
                            id: "BLM",
                            name: "Black Mage",
                            icon: "icons/blackmage.png",
                        },
                        {
                            id: "SMN",
                            name: "Summoner",
                            icon: "icons/summoner.png",
                        },
                        {
                            id: "RDM",
                            name: "Red Mage",
                            icon: "icons/redmage.png",
                        },
                        {
                            id: "PCT",
                            name: "Pictomancer",
                            icon: "icons/pictomancer.png",
                        },
                    ],
                };

                const JOB_CATEGORIES = [
                    { key: "tanks", label: "Tanks" },
                    { key: "healers", label: "Healers" },
                    { key: "melee", label: "Melee DPS" },
                    { key: "ranged", label: "Physical Ranged" },
                    { key: "casters", label: "Magical Ranged" },
                ];

                // Equipment slots - all 11 gear slots
                const GEAR_SLOTS = [
                    { id: "weapon", name: "Weapon" },
                    { id: "head", name: "Head" },
                    { id: "body", name: "Body" },
                    { id: "hands", name: "Hands" },
                    { id: "legs", name: "Legs" },
                    { id: "feet", name: "Feet" },
                    { id: "earrings", name: "Earrings" },
                    { id: "necklace", name: "Necklace" },
                    { id: "bracelets", name: "Bracelets" },
                    { id: "ring1", name: "Ring 1" },
                    { id: "ring2", name: "Ring 2" },
                ];

                // BiS presets per job - based on typical FFXIV endgame stat priorities
                // Jobs prioritizing different secondary stats have different BiS gear
                // Pattern: Weapon always raid, armor/accessories vary by job
                const JOB_BIS_PRESETS = {
                    // Tanks - generally want Tenacity/DH or Crit builds
                    PLD: {
                        weapon: "raid",
                        head: "tome",
                        body: "raid",
                        hands: "tome",
                        legs: "raid",
                        feet: "tome",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    WAR: {
                        weapon: "raid",
                        head: "raid",
                        body: "tome",
                        hands: "raid",
                        legs: "tome",
                        feet: "raid",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },
                    DRK: {
                        weapon: "raid",
                        head: "tome",
                        body: "raid",
                        hands: "raid",
                        legs: "tome",
                        feet: "tome",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    GNB: {
                        weapon: "raid",
                        head: "raid",
                        body: "raid",
                        hands: "tome",
                        legs: "tome",
                        feet: "raid",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },

                    // Healers - Crit/Det or Piety builds
                    WHM: {
                        weapon: "raid",
                        head: "tome",
                        body: "tome",
                        hands: "raid",
                        legs: "raid",
                        feet: "tome",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },
                    SCH: {
                        weapon: "raid",
                        head: "raid",
                        body: "tome",
                        hands: "tome",
                        legs: "raid",
                        feet: "raid",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "raid",
                        ring2: "raid",
                    },
                    AST: {
                        weapon: "raid",
                        head: "tome",
                        body: "raid",
                        hands: "tome",
                        legs: "tome",
                        feet: "raid",
                        earrings: "tome",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "tome",
                    },
                    SGE: {
                        weapon: "raid",
                        head: "raid",
                        body: "raid",
                        hands: "tome",
                        legs: "tome",
                        feet: "tome",
                        earrings: "raid",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "tome",
                        ring2: "raid",
                    },

                    // Melee DPS - Crit/DH focused
                    MNK: {
                        weapon: "raid",
                        head: "raid",
                        body: "tome",
                        hands: "raid",
                        legs: "raid",
                        feet: "tome",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    DRG: {
                        weapon: "raid",
                        head: "tome",
                        body: "raid",
                        hands: "raid",
                        legs: "tome",
                        feet: "raid",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },
                    NIN: {
                        weapon: "raid",
                        head: "raid",
                        body: "raid",
                        hands: "tome",
                        legs: "tome",
                        feet: "raid",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    SAM: {
                        weapon: "raid",
                        head: "tome",
                        body: "tome",
                        hands: "raid",
                        legs: "raid",
                        feet: "tome",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },
                    RPR: {
                        weapon: "raid",
                        head: "raid",
                        body: "tome",
                        hands: "tome",
                        legs: "raid",
                        feet: "raid",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    VPR: {
                        weapon: "raid",
                        head: "tome",
                        body: "raid",
                        hands: "raid",
                        legs: "tome",
                        feet: "tome",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },

                    // Physical Ranged - Crit/DH focused
                    BRD: {
                        weapon: "raid",
                        head: "raid",
                        body: "tome",
                        hands: "raid",
                        legs: "tome",
                        feet: "raid",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },
                    MCH: {
                        weapon: "raid",
                        head: "tome",
                        body: "raid",
                        hands: "tome",
                        legs: "raid",
                        feet: "tome",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    DNC: {
                        weapon: "raid",
                        head: "raid",
                        body: "raid",
                        hands: "tome",
                        legs: "tome",
                        feet: "raid",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },

                    // Casters - SpS or Crit builds vary
                    BLM: {
                        weapon: "raid",
                        head: "tome",
                        body: "tome",
                        hands: "raid",
                        legs: "raid",
                        feet: "tome",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    SMN: {
                        weapon: "raid",
                        head: "raid",
                        body: "tome",
                        hands: "raid",
                        legs: "tome",
                        feet: "raid",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },
                    RDM: {
                        weapon: "raid",
                        head: "tome",
                        body: "raid",
                        hands: "tome",
                        legs: "tome",
                        feet: "raid",
                        earrings: "raid",
                        necklace: "tome",
                        bracelets: "raid",
                        ring1: "tome",
                        ring2: "raid",
                    },
                    PCT: {
                        weapon: "raid",
                        head: "raid",
                        body: "raid",
                        hands: "tome",
                        legs: "raid",
                        feet: "tome",
                        earrings: "tome",
                        necklace: "raid",
                        bracelets: "tome",
                        ring1: "raid",
                        ring2: "tome",
                    },
                };

                // Raid turn mapping - which boss drops which slot
                const RAID_TURNS = {
                    weapon: { turn: 4, label: "4th Turn" },
                    head: { turn: 2, label: "2nd Turn" },
                    body: { turn: 3, label: "3rd Turn" },
                    hands: { turn: 2, label: "2nd Turn" },
                    legs: { turn: 3, label: "3rd Turn" },
                    feet: { turn: 2, label: "2nd Turn" },
                    earrings: { turn: 1, label: "1st Turn" },
                    necklace: { turn: 1, label: "1st Turn" },
                    bracelets: { turn: 1, label: "1st Turn" },
                    ring1: { turn: 1, label: "1st Turn" },
                    ring2: { turn: 1, label: "1st Turn" },
                };

                // Tomestone cost mapping - how many tomes each slot costs
                const TOME_COSTS = {
                    weapon: 500,
                    head: 495,
                    body: 825,
                    hands: 495,
                    legs: 825,
                    feet: 495,
                    earrings: 375,
                    necklace: 375,
                    bracelets: 375,
                    ring1: 375,
                    ring2: 375,
                };

                // Fallback default BiS preset
                const DEFAULT_BIS = {
                    weapon: "raid",
                    head: "tome",
                    body: "raid",
                    hands: "raid",
                    legs: "tome",
                    feet: "tome",
                    earrings: "tome",
                    necklace: "raid",
                    bracelets: "tome",
                    ring1: "raid",
                    ring2: "tome",
                };

                // Get BiS preset for a job
                function getBiSPreset(jobId) {
                    return JOB_BIS_PRESETS[jobId] || DEFAULT_BIS;
                }

                // Get effective slot type (override or preset)
                function getSlotType(jobId, slotId, slotTypeOverrides) {
                    if (slotTypeOverrides && slotTypeOverrides[slotId]) {
                        return slotTypeOverrides[slotId];
                    }
                    const preset = getBiSPreset(jobId);
                    return preset[slotId];
                }

                // Calculate job completion progress
                // Returns { complete: number, total: number }
                // Tome slots only count as complete when upgraded=true
                function calculateJobProgress(jobId, gear, slotTypeOverrides) {
                    let complete = 0;
                    const total = GEAR_SLOTS.length;

                    GEAR_SLOTS.forEach((slot) => {
                        const slotType = getSlotType(
                            jobId,
                            slot.id,
                            slotTypeOverrides,
                        );
                        const slotGear = gear[slot.id] || {};

                        if (slotType === "raid") {
                            if (slotGear.have) complete++;
                        } else {
                            // Tome: only complete when upgraded
                            if (slotGear.upgraded) complete++;
                        }
                    });

                    return { complete, total };
                }

                // Calculate remaining raid drops by turn
                // Returns { 1: count, 2: count, 3: count, 4: count }
                function calculateRaidDropsByTurn(
                    jobId,
                    gear,
                    slotTypeOverrides,
                ) {
                    const dropsByTurn = { 1: 0, 2: 0, 3: 0, 4: 0 };

                    GEAR_SLOTS.forEach((slot) => {
                        const slotType = getSlotType(
                            jobId,
                            slot.id,
                            slotTypeOverrides,
                        );
                        if (slotType !== "raid") return;

                        const slotGear = gear[slot.id] || {};
                        if (!slotGear.have) {
                            const turnInfo = RAID_TURNS[slot.id];
                            if (turnInfo) {
                                dropsByTurn[turnInfo.turn]++;
                            }
                        }
                    });

                    return dropsByTurn;
                }

                // Calculate total tomestones needed for incomplete tome slots
                function calculateTomestonesNeeded(
                    jobId,
                    gear,
                    slotTypeOverrides,
                ) {
                    let total = 0;

                    GEAR_SLOTS.forEach((slot) => {
                        const slotType = getSlotType(
                            jobId,
                            slot.id,
                            slotTypeOverrides,
                        );
                        if (slotType !== "tome") return;

                        const slotGear = gear[slot.id] || {};
                        // Only count if base not purchased - base costs tomes, upgrade does not
                        if (!slotGear.base) {
                            const cost = TOME_COSTS[slot.id];
                            if (cost) {
                                total += cost;
                            }
                        }
                    });

                    return total;
                }

                // Jewelry slots that require Glaze to upgrade
                const JEWELRY_SLOTS = [
                    "earrings",
                    "necklace",
                    "bracelets",
                    "ring1",
                    "ring2",
                ];

                // Armor slots that require Twine to upgrade (non-weapon, non-jewelry)
                const ARMOR_SLOTS = ["head", "body", "hands", "legs", "feet"];

                // Calculate Glaze needed for tome jewelry upgrades
                // Glaze drops from 2nd Turn, upgrades tome jewelry
                function calculateGlazeNeeded(jobId, gear, slotTypeOverrides) {
                    let count = 0;

                    JEWELRY_SLOTS.forEach((slotId) => {
                        const slotType = getSlotType(
                            jobId,
                            slotId,
                            slotTypeOverrides,
                        );
                        if (slotType !== "tome") return;

                        const slotGear = gear[slotId] || {};
                        // Need Glaze if tome jewelry not upgraded (regardless of base status)
                        if (!slotGear.upgraded) {
                            count++;
                        }
                    });

                    return count;
                }

                // Calculate Twine needed for tome armor upgrades
                // Twine drops from 3rd Turn, upgrades tome armor (head/body/hands/legs/feet)
                function calculateTwineNeeded(jobId, gear, slotTypeOverrides) {
                    let count = 0;

                    ARMOR_SLOTS.forEach((slotId) => {
                        const slotType = getSlotType(
                            jobId,
                            slotId,
                            slotTypeOverrides,
                        );
                        if (slotType !== "tome") return;

                        const slotGear = gear[slotId] || {};
                        // Need Twine if tome armor not upgraded (regardless of base status)
                        if (!slotGear.upgraded) {
                            count++;
                        }
                    });

                    return count;
                }

                // Calculate Solvent needed for tome weapon upgrade
                // Solvent drops from 3rd Turn, upgrades tome weapon
                function calculateSolventNeeded(
                    jobId,
                    gear,
                    slotTypeOverrides,
                ) {
                    const slotType = getSlotType(
                        jobId,
                        "weapon",
                        slotTypeOverrides,
                    );
                    if (slotType !== "tome") return 0;

                    const slotGear = gear["weapon"] || {};
                    // Need Solvent if tome weapon not upgraded (regardless of base status)
                    return slotGear.upgraded ? 0 : 1;
                }

                // Get flat list of all jobs
                function getAllJobs() {
                    return Object.values(JOBS).flat();
                }

                // Get job by ID
                function getJobById(id) {
                    return getAllJobs().find((j) => j.id === id);
                }

                // State
                let state = {
                    characters: [],
                    selectedCharacterId: null,
                    selectedJobId: null,
                };

                // Input modal callback
                let inputModalCallback = null;

                // Confirm modal callback
                let confirmModalCallback = null;

                // DOM Elements
                const addCharacterBtn =
                    document.getElementById("add-character-btn");
                const characterListContainer = document.getElementById(
                    "character-list-container",
                );
                const characterNameHeader =
                    document.getElementById("character-name");
                const characterSubtitle =
                    document.getElementById("character-subtitle");
                const emptyState = document.getElementById("empty-state");
                const characterDetails =
                    document.getElementById("character-details");
                const jobModal = document.getElementById("job-modal");
                const jobModalTitle =
                    document.getElementById("job-modal-title");
                const jobModalSubtitle =
                    document.getElementById("job-modal-subtitle");
                const jobModalIcon = document.getElementById("job-modal-icon");
                const jobModalContent =
                    document.getElementById("job-modal-content");
                const jobModalStep1 =
                    document.getElementById("job-modal-step1");
                const jobModalStep2 =
                    document.getElementById("job-modal-step2");
                const bisConfigContent =
                    document.getElementById("bis-config-content");
                const jobModalBack = document.getElementById("job-modal-back");
                const jobModalClose =
                    document.getElementById("job-modal-close");
                const exportBtn = document.getElementById("export-btn");

                // Job modal state
                let pendingJobId = null;
                let manualSlotConfig = {};
                const inputModal = document.getElementById("input-modal");
                const inputModalTitle =
                    document.getElementById("input-modal-title");
                const inputModalField =
                    document.getElementById("input-modal-field");
                const inputModalCancel =
                    document.getElementById("input-modal-cancel");
                const inputModalConfirm = document.getElementById(
                    "input-modal-confirm",
                );
                const confirmModal = document.getElementById("confirm-modal");
                const confirmModalTitle = document.getElementById(
                    "confirm-modal-title",
                );
                const confirmModalMessage = document.getElementById(
                    "confirm-modal-message",
                );
                const confirmModalCancel = document.getElementById(
                    "confirm-modal-cancel",
                );
                const confirmModalConfirmBtn = document.getElementById(
                    "confirm-modal-confirm",
                );

                // Slot config modal elements
                const slotConfigModal =
                    document.getElementById("slot-config-modal");
                const slotConfigIcon =
                    document.getElementById("slot-config-icon");
                const slotConfigTitle =
                    document.getElementById("slot-config-title");
                const slotConfigRaidBtn =
                    document.getElementById("slot-config-raid");
                const slotConfigTomeBtn =
                    document.getElementById("slot-config-tome");
                const slotConfigRaidTurn = document.getElementById(
                    "slot-config-raid-turn",
                );
                const slotConfigTomeCost = document.getElementById(
                    "slot-config-tome-cost",
                );
                const slotConfigCancel =
                    document.getElementById("slot-config-cancel");

                // Slot config modal state
                let slotConfigSlotId = null;

                // Initialize
                function init() {
                    loadState();
                    checkForImport();
                    render();
                    attachEventListeners();
                }

                // Check URL for data parameter and prompt import
                function checkForImport() {
                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const dataParam = urlParams.get("data");

                    if (!dataParam) return;

                    try {
                        // Decode the base64 data
                        const jsonStr = decodeURIComponent(atob(dataParam));
                        const importedState = JSON.parse(jsonStr);

                        // Validate imported data structure
                        if (
                            !importedState ||
                            !Array.isArray(importedState.characters)
                        ) {
                            throw new Error("Invalid data format");
                        }

                        // Count characters and jobs for prompt
                        const charCount = importedState.characters.length;
                        let jobCount = 0;
                        importedState.characters.forEach((c) => {
                            if (c.jobs) jobCount += c.jobs.length;
                        });

                        // Prompt user
                        const msg = `Import ${charCount} character(s) with ${jobCount} job(s)?\n\nThis will replace your current data.`;
                        if (confirm(msg)) {
                            // Apply imported state
                            state = importedState;
                            saveState();
                        }

                        // Clean URL (remove data param) regardless of choice
                        const url = new URL(window.location.href);
                        url.search = "";
                        window.history.replaceState({}, "", url.toString());
                    } catch (e) {
                        console.error("Import failed:", e);
                        alert(
                            "Failed to import data: Invalid or corrupted URL.",
                        );

                        // Clean URL
                        const url = new URL(window.location.href);
                        url.search = "";
                        window.history.replaceState({}, "", url.toString());
                    }
                }

                // Local Storage
                function loadState() {
                    const saved = localStorage.getItem("wtfdin-data");
                    if (saved) {
                        try {
                            state = JSON.parse(saved);
                        } catch (e) {
                            console.error("Failed to parse saved state:", e);
                        }
                    }
                }

                function saveState() {
                    localStorage.setItem("wtfdin-data", JSON.stringify(state));
                }

                // Event Listeners
                function attachEventListeners() {
                    addCharacterBtn.addEventListener(
                        "click",
                        handleAddCharacter,
                    );
                    jobModalClose.addEventListener("click", closeJobModal);
                    jobModalBack.addEventListener("click", handleJobModalBack);
                    jobModal.addEventListener("click", (e) => {
                        if (e.target === jobModal) closeJobModal();
                    });
                    exportBtn.addEventListener("click", handleExport);

                    // Input modal events
                    inputModalCancel.addEventListener("click", closeInputModal);
                    inputModalConfirm.addEventListener(
                        "click",
                        handleInputModalConfirm,
                    );
                    inputModal.addEventListener("click", (e) => {
                        if (e.target === inputModal) closeInputModal();
                    });
                    inputModalField.addEventListener("keydown", (e) => {
                        if (e.key === "Enter") handleInputModalConfirm();
                        if (e.key === "Escape") closeInputModal();
                    });

                    // Confirm modal events
                    confirmModalCancel.addEventListener(
                        "click",
                        closeConfirmModal,
                    );
                    confirmModalConfirmBtn.addEventListener(
                        "click",
                        handleConfirmModalConfirm,
                    );
                    confirmModal.addEventListener("click", (e) => {
                        if (e.target === confirmModal) closeConfirmModal();
                    });
                    document.addEventListener("keydown", (e) => {
                        if (
                            e.key === "Escape" &&
                            !confirmModal.classList.contains("hidden")
                        ) {
                            closeConfirmModal();
                        }
                    });

                    // Slot config modal events
                    slotConfigCancel.addEventListener(
                        "click",
                        closeSlotConfigModal,
                    );
                    slotConfigModal.addEventListener("click", (e) => {
                        if (e.target === slotConfigModal)
                            closeSlotConfigModal();
                    });
                    slotConfigRaidBtn.addEventListener("click", () =>
                        selectSlotType("raid"),
                    );
                    slotConfigTomeBtn.addEventListener("click", () =>
                        selectSlotType("tome"),
                    );
                }

                // Input Modal Functions
                function openInputModal(
                    title,
                    defaultValue,
                    confirmText,
                    callback,
                ) {
                    inputModalTitle.textContent = title;
                    inputModalField.value = defaultValue || "";
                    inputModalConfirm.textContent = confirmText || "Confirm";
                    inputModalCallback = callback;
                    inputModal.classList.remove("hidden");
                    inputModalField.focus();
                    inputModalField.select();
                }

                function closeInputModal() {
                    inputModal.classList.add("hidden");
                    inputModalCallback = null;
                    inputModalField.value = "";
                }

                function handleInputModalConfirm() {
                    const value = inputModalField.value.trim();
                    if (inputModalCallback) {
                        inputModalCallback(value);
                    }
                    closeInputModal();
                }

                // Confirm Modal Functions
                function openConfirmModal(
                    title,
                    message,
                    confirmText,
                    callback,
                ) {
                    confirmModalTitle.textContent = title;
                    confirmModalMessage.textContent = message;
                    confirmModalConfirmBtn.textContent =
                        confirmText || "Delete";
                    confirmModalCallback = callback;
                    confirmModal.classList.remove("hidden");
                    confirmModalConfirmBtn.focus();
                }

                function closeConfirmModal() {
                    confirmModal.classList.add("hidden");
                    confirmModalCallback = null;
                }

                function handleConfirmModalConfirm() {
                    if (confirmModalCallback) {
                        confirmModalCallback();
                    }
                    closeConfirmModal();
                }

                // Slot Config Modal Functions
                const SLOT_ICONS = {
                    weapon: "",
                    head: "",
                    body: "",
                    hands: "",
                    legs: "",
                    feet: "",
                    earrings: "",
                    necklace: "",
                    bracelets: "",
                    ring1: "",
                    ring2: "",
                };

                function openSlotConfigModal(slotId, currentType) {
                    const slot = GEAR_SLOTS.find((s) => s.id === slotId);
                    if (!slot) return;

                    slotConfigSlotId = slotId;

                    // Set title and icon
                    slotConfigTitle.textContent = `Configure ${slot.name}`;
                    slotConfigIcon.textContent = SLOT_ICONS[slotId] || "";

                    // Set raid turn info
                    const raidTurn = RAID_TURNS[slotId];
                    slotConfigRaidTurn.textContent = raidTurn
                        ? raidTurn.label
                        : "";

                    // Set tome cost info
                    const tomeCost = TOME_COSTS[slotId];
                    slotConfigTomeCost.textContent = tomeCost
                        ? `${tomeCost} tomes`
                        : "";

                    // Set current selection
                    slotConfigRaidBtn.classList.toggle(
                        "selected",
                        currentType === "raid",
                    );
                    slotConfigTomeBtn.classList.toggle(
                        "selected",
                        currentType === "tome",
                    );

                    slotConfigModal.classList.remove("hidden");
                }

                function closeSlotConfigModal() {
                    slotConfigModal.classList.add("hidden");
                    slotConfigSlotId = null;
                }

                function selectSlotType(newType) {
                    if (!slotConfigSlotId) return;

                    const selected = state.characters.find(
                        (c) => c.id === state.selectedCharacterId,
                    );
                    if (!selected) return;

                    const jobData = selected.jobs.find(
                        (j) => j.jobId === state.selectedJobId,
                    );
                    if (!jobData) return;

                    // Get current type
                    const currentType = getSlotType(
                        jobData.jobId,
                        slotConfigSlotId,
                        jobData.slotTypeOverrides,
                    );

                    // Only update if type actually changed
                    if (currentType !== newType) {
                        // Initialize slot type overrides if needed
                        if (!jobData.slotTypeOverrides)
                            jobData.slotTypeOverrides = {};

                        jobData.slotTypeOverrides[slotConfigSlotId] = newType;

                        // Reset checkbox state when type changes
                        if (!jobData.gear) jobData.gear = {};
                        jobData.gear[slotConfigSlotId] = {};

                        saveState();
                        render();
                    }

                    closeSlotConfigModal();
                }

                // Export/Import
                function handleExport() {
                    if (state.characters.length === 0) {
                        alert("No data to export. Add some characters first!");
                        return;
                    }

                    try {
                        // Encode state as base64
                        const jsonStr = JSON.stringify(state);
                        const base64 = btoa(encodeURIComponent(jsonStr));

                        // Build URL with data parameter
                        const url = new URL(window.location.href);
                        url.search = ""; // Clear existing params
                        url.searchParams.set("data", base64);

                        // Copy to clipboard
                        navigator.clipboard
                            .writeText(url.toString())
                            .then(() => {
                                alert("URL copied to clipboard!");
                            })
                            .catch(() => {
                                // Fallback: show URL in prompt
                                prompt(
                                    "Copy this URL to share your data:",
                                    url.toString(),
                                );
                            });
                    } catch (e) {
                        console.error("Export failed:", e);
                        alert(
                            "Failed to export data. See console for details.",
                        );
                    }
                }

                function handleAddCharacter() {
                    openInputModal("Add Character", "", "Create", (name) => {
                        if (name) {
                            const character = {
                                id: Date.now().toString(),
                                name: name,
                                jobs: [],
                            };
                            state.characters.push(character);
                            state.selectedCharacterId = character.id;
                            saveState();
                            render();
                        }
                    });
                }

                function selectCharacter(id) {
                    state.selectedCharacterId = id;
                    // Auto-select first job if character has jobs
                    const char = state.characters.find((c) => c.id === id);
                    if (char && char.jobs.length > 0) {
                        state.selectedJobId = char.jobs[0].jobId;
                    } else {
                        state.selectedJobId = null;
                    }
                    saveState();
                    render();
                }

                function handleRenameCharacter(id) {
                    const char = state.characters.find((c) => c.id === id);
                    if (!char) return;

                    openInputModal(
                        "Rename Character",
                        char.name,
                        "Confirm",
                        (newName) => {
                            if (newName && newName !== char.name) {
                                char.name = newName;
                                saveState();
                                render();
                            }
                        },
                    );
                }

                function handleDeleteCharacter(id) {
                    const char = state.characters.find((c) => c.id === id);
                    if (!char) return;

                    openConfirmModal(
                        "Delete Character",
                        `Delete "${char.name}" and all their job data?`,
                        "Delete",
                        () => {
                            // Remove character from array
                            state.characters = state.characters.filter(
                                (c) => c.id !== id,
                            );

                            // Clear selection if deleted character was selected
                            if (state.selectedCharacterId === id) {
                                state.selectedCharacterId =
                                    state.characters.length > 0
                                        ? state.characters[0].id
                                        : null;
                                state.selectedJobId = null;
                                // Auto-select first job of new selected character
                                if (state.selectedCharacterId) {
                                    const newSelected = state.characters.find(
                                        (c) =>
                                            c.id === state.selectedCharacterId,
                                    );
                                    if (
                                        newSelected &&
                                        newSelected.jobs.length > 0
                                    ) {
                                        state.selectedJobId =
                                            newSelected.jobs[0].jobId;
                                    }
                                }
                            }

                            saveState();
                            render();
                        },
                    );
                }

                function selectJob(jobId) {
                    state.selectedJobId = jobId;
                    saveState();
                    render();
                }

                function handleRemoveJob(jobId) {
                    const selected = state.characters.find(
                        (c) => c.id === state.selectedCharacterId,
                    );
                    if (!selected) return;

                    const job = getJobById(jobId);
                    const jobName = job ? job.name : jobId;

                    openConfirmModal(
                        "Remove Job",
                        `Remove ${jobName} and all its gear data?`,
                        "Remove",
                        () => {
                            // Remove job from character
                            selected.jobs = selected.jobs.filter(
                                (j) => j.jobId !== jobId,
                            );

                            // Clear selected job if removed job was selected
                            if (state.selectedJobId === jobId) {
                                state.selectedJobId =
                                    selected.jobs.length > 0
                                        ? selected.jobs[0].jobId
                                        : null;
                            }

                            saveState();
                            render();
                        },
                    );
                }

                // Job Modal
                function openJobModal() {
                    const selected = state.characters.find(
                        (c) => c.id === state.selectedCharacterId,
                    );
                    if (!selected) return;

                    // Reset to step 1
                    pendingJobId = null;
                    manualSlotConfig = {};
                    showJobModalStep(1);

                    const existingJobIds = selected.jobs.map((j) => j.jobId);

                    const categoryIcons = {
                        tanks: "",
                        healers: "",
                        melee: "",
                        ranged: "",
                        casters: "",
                    };

                    let html = "";
                    JOB_CATEGORIES.forEach((cat) => {
                        html += `<div class="job-category">
                        <div class="job-category-header">
                            <div class="job-category-icon ${cat.key}">${categoryIcons[cat.key]}</div>
                            <h4>${cat.label}</h4>
                        </div>
                        <div class="job-grid">`;
                        JOBS[cat.key].forEach((job) => {
                            const isDisabled = existingJobIds.includes(job.id);
                            html += `
                            <div class="job-grid-item ${isDisabled ? "disabled" : ""}"
                                 data-job-id="${job.id}"
                                 ${isDisabled ? "" : 'tabindex="0"'}>
                                <div class="job-grid-item-icon">
                                    <img src="${job.icon}" alt="${job.name}" data-job-id="${job.id}">
                                </div>
                                <span>${job.name}</span>
                            </div>
                        `;
                        });
                        html += "</div></div>";
                    });

                    jobModalContent.innerHTML = html;

                    // Attach click handlers to job items
                    jobModalContent
                        .querySelectorAll(".job-grid-item:not(.disabled)")
                        .forEach((item) => {
                            item.addEventListener("click", () =>
                                showBisConfigStep(item.dataset.jobId),
                            );
                            item.addEventListener("keydown", (e) => {
                                if (e.key === "Enter" || e.key === " ") {
                                    e.preventDefault();
                                    showBisConfigStep(item.dataset.jobId);
                                }
                            });
                        });

                    // Attach job icon error handlers for modal
                    jobModalContent
                        .querySelectorAll(".job-grid-item img")
                        .forEach((img) => {
                            img.onerror = () =>
                                handleJobIconError(img, img.dataset.jobId);
                        });

                    jobModal.classList.remove("hidden");
                }

                function showJobModalStep(step) {
                    if (step === 1) {
                        jobModalTitle.textContent = "Add Job";
                        jobModalSubtitle.textContent =
                            "Select a job to track gear for";
                        jobModalIcon.textContent = "+";
                        jobModalStep1.classList.add("active");
                        jobModalStep2.classList.remove("active");
                        jobModalBack.classList.add("hidden");
                    } else {
                        const job = getJobById(pendingJobId);
                        jobModalTitle.textContent = `Configure ${job ? job.name : ""} BiS`;
                        jobModalSubtitle.textContent =
                            "Choose how to set up gear tracking";
                        jobModalIcon.textContent = "";
                        jobModalStep1.classList.remove("active");
                        jobModalStep2.classList.add("active");
                        jobModalBack.classList.remove("hidden");
                    }
                }

                function handleJobModalBack() {
                    pendingJobId = null;
                    manualSlotConfig = {};
                    showJobModalStep(1);
                }

                function showBisConfigStep(jobId) {
                    pendingJobId = jobId;
                    const preset = getBiSPreset(jobId);

                    // Initialize manual config with preset values
                    manualSlotConfig = { ...preset };

                    const job = getJobById(jobId);

                    let html = `
                    <div class="bis-option-buttons">
                        <button class="bis-option-btn" id="use-preset-btn" tabindex="0">
                            <h4>Use Preset BiS</h4>
                            <p>Apply recommended gear configuration</p>
                        </button>
                        <button class="bis-option-btn" id="use-manual-btn" tabindex="0">
                            <h4>Configure Manually</h4>
                            <p>Choose raid/tome for each slot</p>
                        </button>
                    </div>
                    <div id="manual-config-section" style="display: none;">
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 12px;">Toggle each slot between Raid and Tome:</p>
                        <div class="bis-slot-grid">
                `;

                    GEAR_SLOTS.forEach((slot) => {
                        const slotType = manualSlotConfig[slot.id] || "raid";
                        html += `
                        <div class="bis-slot-item" data-slot="${slot.id}">
                            <span class="slot-name">${slot.name}</span>
                            <div class="bis-slot-toggle" data-slot="${slot.id}">
                                <button data-type="raid" class="${slotType === "raid" ? "active" : ""}">Raid</button>
                                <button data-type="tome" class="${slotType === "tome" ? "active" : ""}">Tome</button>
                            </div>
                        </div>
                    `;
                    });

                    html += `
                        </div>
                        <button class="btn" id="confirm-manual-btn" style="margin-top: 16px; width: 100%;">Add ${job ? job.name : "Job"}</button>
                    </div>
                `;

                    bisConfigContent.innerHTML = html;

                    // Attach preset button handler
                    document
                        .getElementById("use-preset-btn")
                        .addEventListener("click", () => {
                            addJobWithConfig(jobId, null); // null = use preset
                        });

                    // Attach manual button handler
                    document
                        .getElementById("use-manual-btn")
                        .addEventListener("click", () => {
                            document.getElementById(
                                "manual-config-section",
                            ).style.display = "block";
                            document.querySelector(
                                ".bis-option-buttons",
                            ).style.display = "none";
                        });

                    // Attach slot toggle handlers
                    bisConfigContent
                        .querySelectorAll(".bis-slot-toggle")
                        .forEach((toggle) => {
                            const slotId = toggle.dataset.slot;
                            toggle.querySelectorAll("button").forEach((btn) => {
                                btn.addEventListener("click", () => {
                                    const type = btn.dataset.type;
                                    manualSlotConfig[slotId] = type;
                                    // Update active states
                                    toggle
                                        .querySelectorAll("button")
                                        .forEach((b) =>
                                            b.classList.remove("active"),
                                        );
                                    btn.classList.add("active");
                                });
                            });
                        });

                    // Attach confirm manual button handler
                    document
                        .getElementById("confirm-manual-btn")
                        .addEventListener("click", () => {
                            addJobWithConfig(jobId, manualSlotConfig);
                        });

                    showJobModalStep(2);
                }

                function closeJobModal() {
                    jobModal.classList.add("hidden");
                    pendingJobId = null;
                    manualSlotConfig = {};
                }

                function addJobWithConfig(jobId, slotOverrides) {
                    const selected = state.characters.find(
                        (c) => c.id === state.selectedCharacterId,
                    );
                    if (!selected) return;

                    // Check if job already exists
                    if (selected.jobs.some((j) => j.jobId === jobId)) return;

                    // Build slot type overrides if manual config differs from preset
                    let slotTypeOverrides = {};
                    if (slotOverrides) {
                        const preset = getBiSPreset(jobId);
                        GEAR_SLOTS.forEach((slot) => {
                            if (slotOverrides[slot.id] !== preset[slot.id]) {
                                slotTypeOverrides[slot.id] =
                                    slotOverrides[slot.id];
                            }
                        });
                    }

                    // Add job with empty gear slots and any overrides
                    const jobData = {
                        jobId: jobId,
                        gear: {},
                    };
                    if (Object.keys(slotTypeOverrides).length > 0) {
                        jobData.slotTypeOverrides = slotTypeOverrides;
                    }
                    selected.jobs.push(jobData);

                    // Auto-select the newly added job
                    state.selectedJobId = jobId;

                    saveState();
                    closeJobModal();
                    render();
                }

                // Rendering
                function render() {
                    renderCharacterList();
                    renderMainPanel();
                }

                function getInitials(name) {
                    const words = name.trim().split(/\s+/);
                    if (words.length >= 2) {
                        return (words[0][0] + words[1][0]).toUpperCase();
                    }
                    return name.slice(0, 2).toUpperCase();
                }

                function renderCharacterList() {
                    // Update character count
                    const countEl = document.getElementById("character-count");
                    if (countEl) countEl.textContent = state.characters.length;

                    if (state.characters.length === 0) {
                        characterListContainer.innerHTML =
                            '<p class="no-characters">No characters yet.<br>Add one to get started!</p>';
                        return;
                    }

                    characterListContainer.innerHTML = state.characters
                        .map(
                            (char) => `
                    <div class="character-item ${char.id === state.selectedCharacterId ? "selected" : ""}"
                         data-id="${char.id}"
                         tabindex="0"
                         role="button">
                        <div class="character-avatar">${getInitials(char.name)}</div>
                        <div class="character-item-content">
                            <span class="name">${escapeHtml(char.name)}</span>
                        </div>
                        <div class="character-item-actions">
                            <button class="btn btn-small btn-rename" data-rename-id="${char.id}">Rename</button>
                            <button class="btn btn-small btn-delete" data-delete-id="${char.id}">Delete</button>
                        </div>
                    </div>
                `,
                        )
                        .join("");

                    // Attach click handlers for selecting character
                    characterListContainer
                        .querySelectorAll(".character-item")
                        .forEach((item) => {
                            item.addEventListener("click", (e) => {
                                // Don't select if clicking action buttons
                                if (
                                    e.target.classList.contains("btn-delete") ||
                                    e.target.classList.contains("btn-rename")
                                )
                                    return;
                                selectCharacter(item.dataset.id);
                            });
                            item.addEventListener("keydown", (e) => {
                                if (e.key === "Enter" || e.key === " ") {
                                    e.preventDefault();
                                    selectCharacter(item.dataset.id);
                                }
                            });
                        });

                    // Attach rename handlers
                    characterListContainer
                        .querySelectorAll(".btn-rename")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                e.stopPropagation();
                                handleRenameCharacter(btn.dataset.renameId);
                            });
                        });

                    // Attach delete handlers
                    characterListContainer
                        .querySelectorAll(".btn-delete")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                e.stopPropagation();
                                handleDeleteCharacter(btn.dataset.deleteId);
                            });
                        });
                }

                function renderMainPanel() {
                    const selected = state.characters.find(
                        (c) => c.id === state.selectedCharacterId,
                    );

                    if (!selected) {
                        characterNameHeader.textContent = "Select a Character";
                        characterSubtitle.textContent = "";
                        characterSubtitle.style.display = "none";
                        emptyState.style.display = "flex";
                        characterDetails.style.display = "none";
                        return;
                    }

                    characterNameHeader.textContent = selected.name;
                    const jobCount = selected.jobs.length;
                    if (jobCount > 0) {
                        characterSubtitle.textContent =
                            jobCount === 1
                                ? "1 job tracked"
                                : `${jobCount} jobs tracked`;
                        characterSubtitle.style.display = "block";
                    } else {
                        characterSubtitle.textContent = "";
                        characterSubtitle.style.display = "none";
                    }
                    emptyState.style.display = "none";
                    characterDetails.style.display = "block";

                    // Render jobs with section header
                    let jobsHtml = '<div class="job-section">';
                    jobsHtml += `<div class="job-section-header">
                    <span class="job-section-title">Jobs</span>
                    <span class="job-count">${selected.jobs.length}</span>
                </div>`;
                    jobsHtml += '<div class="job-pills">';
                    if (selected.jobs.length > 0) {
                        selected.jobs.forEach((j) => {
                            const job = getJobById(j.jobId);
                            if (job) {
                                const isSelected =
                                    j.jobId === state.selectedJobId;
                                jobsHtml += `
                                <div class="job-pill ${isSelected ? "selected" : ""}" data-job-id="${job.id}" tabindex="0">
                                    <div class="job-pill-icon">
                                        <img src="${job.icon}" alt="${job.name}" data-job-id="${job.id}">
                                    </div>
                                    <span class="job-pill-name">${job.name}</span>
                                    <button class="job-remove-btn" data-remove-job-id="${job.id}" title="Remove ${job.name}">&times;</button>
                                </div>
                            `;
                            }
                        });
                    }
                    jobsHtml += `<button class="btn-add-job" id="add-job-btn">Add Job</button>`;
                    jobsHtml += "</div></div>";

                    // Get selected job info and gear table
                    const selectedJob = state.selectedJobId
                        ? getJobById(state.selectedJobId)
                        : null;
                    const selectedJobData = selected.jobs.find(
                        (j) => j.jobId === state.selectedJobId,
                    );
                    let jobInfoHtml = "";

                    if (selectedJob && selectedJobData) {
                        const gear = selectedJobData.gear || {};
                        const slotTypeOverrides =
                            selectedJobData.slotTypeOverrides || {};

                        // Two-column layout: Left = armor, Right = accessories
                        const LEFT_SLOTS = [
                            "weapon",
                            "head",
                            "body",
                            "hands",
                            "legs",
                            "feet",
                        ];
                        const RIGHT_SLOTS = [
                            "earrings",
                            "necklace",
                            "bracelets",
                            "ring1",
                            "ring2",
                        ];

                        function buildSlotRow(slot) {
                            const slotType = getSlotType(
                                selectedJob.id,
                                slot.id,
                                slotTypeOverrides,
                            );
                            const slotGear = gear[slot.id] || {};

                            let checkboxHtml = "";
                            if (slotType === "raid") {
                                const hasItem = slotGear.have || false;
                                checkboxHtml = `
                                <label class="gear-checkbox-label">
                                    <input type="checkbox" data-slot="${slot.id}" data-field="have" ${hasItem ? "checked" : ""}>
                                    Have
                                </label>
                            `;
                            } else {
                                const hasBase = slotGear.base || false;
                                const hasUpgraded = slotGear.upgraded || false;
                                checkboxHtml = `
                                <label class="gear-checkbox-label">
                                    <input type="checkbox" data-slot="${slot.id}" data-field="base" ${hasBase ? "checked" : ""}>
                                    Base
                                </label>
                                <label class="gear-checkbox-label">
                                    <input type="checkbox" data-slot="${slot.id}" data-field="upgraded" ${hasUpgraded ? "checked" : ""}>
                                    Upgraded
                                </label>
                            `;
                            }

                            let slotClass = "";
                            if (slotType === "raid") {
                                if (slotGear.have) slotClass = "slot-complete";
                            } else {
                                if (slotGear.upgraded) {
                                    slotClass = "slot-complete";
                                } else if (slotGear.base) {
                                    slotClass = "slot-partial";
                                }
                            }

                            let typeLabel =
                                slotType.charAt(0).toUpperCase() +
                                slotType.slice(1);
                            let extraLabel = "";
                            if (slotType === "raid") {
                                const turnInfo = RAID_TURNS[slot.id];
                                if (turnInfo) {
                                    extraLabel = `<span class="turn-label">${turnInfo.label}</span>`;
                                }
                            } else if (slotType === "tome") {
                                const cost = TOME_COSTS[slot.id];
                                if (cost) {
                                    extraLabel = `<span class="tome-cost">${cost}</span>`;
                                }
                            }

                            return `
                            <div class="gear-table-row ${slotClass}" data-slot="${slot.id}">
                                <div class="gear-table-cell slot-name">${slot.name}</div>
                                <div class="gear-table-cell"><span class="slot-type ${slotType}" data-slot="${slot.id}" data-type="${slotType}" tabindex="0" role="button" title="Click to toggle type">${typeLabel}</span></div>
                                <div class="gear-table-cell">${extraLabel}</div>
                                <div class="gear-table-cell"><div class="gear-checkbox-group">${checkboxHtml}</div></div>
                            </div>
                        `;
                        }

                        let leftColumnRows = "";
                        LEFT_SLOTS.forEach((slotId) => {
                            const slot = GEAR_SLOTS.find(
                                (s) => s.id === slotId,
                            );
                            if (slot) leftColumnRows += buildSlotRow(slot);
                        });

                        let rightColumnRows = "";
                        RIGHT_SLOTS.forEach((slotId) => {
                            const slot = GEAR_SLOTS.find(
                                (s) => s.id === slotId,
                            );
                            if (slot) rightColumnRows += buildSlotRow(slot);
                        });

                        // Calculate progress
                        const progress = calculateJobProgress(
                            selectedJob.id,
                            gear,
                            slotTypeOverrides,
                        );
                        const progressPercent = Math.round(
                            (progress.complete / progress.total) * 100,
                        );
                        const isComplete = progress.complete === progress.total;

                        // Calculate raid drops by turn for summary
                        const raidDrops = calculateRaidDropsByTurn(
                            selectedJob.id,
                            gear,
                            slotTypeOverrides,
                        );
                        const glazeNeeded = calculateGlazeNeeded(
                            selectedJob.id,
                            gear,
                            slotTypeOverrides,
                        );
                        const twineNeeded = calculateTwineNeeded(
                            selectedJob.id,
                            gear,
                            slotTypeOverrides,
                        );
                        const solventNeeded = calculateSolventNeeded(
                            selectedJob.id,
                            gear,
                            slotTypeOverrides,
                        );
                        const turnLabels = {
                            1: "1st Turn",
                            2: "2nd Turn",
                            3: "3rd Turn",
                            4: "4th Turn",
                        };
                        let raidSummaryHtml = "";
                        let hasRaidNeeds = false;
                        [1, 2, 3, 4].forEach((turn) => {
                            const drops = raidDrops[turn];
                            // 2nd Turn also shows Glaze for tome jewelry upgrades
                            const glaze = turn === 2 ? glazeNeeded : 0;
                            // 3rd Turn also shows Twine for tome armor upgrades and Solvent for tome weapon
                            const twine = turn === 3 ? twineNeeded : 0;
                            const solvent = turn === 3 ? solventNeeded : 0;

                            if (
                                drops > 0 ||
                                glaze > 0 ||
                                twine > 0 ||
                                solvent > 0
                            ) {
                                hasRaidNeeds = true;
                                let valueParts = [];
                                if (drops > 0) {
                                    valueParts.push(
                                        `${drops} Coffer${drops !== 1 ? "s" : ""}`,
                                    );
                                }
                                if (glaze > 0) {
                                    valueParts.push(`${glaze} Glaze`);
                                }
                                if (twine > 0) {
                                    valueParts.push(`${twine} Twine`);
                                }
                                if (solvent > 0) {
                                    valueParts.push(`${solvent} Solvent`);
                                }
                                raidSummaryHtml += `
                                <div class="summary-item">
                                    <span class="summary-item-label">${turnLabels[turn]}</span>
                                    <span class="summary-item-value">${valueParts.join(", ")}</span>
                                </div>
                            `;
                            }
                        });

                        if (!hasRaidNeeds) {
                            raidSummaryHtml = `<div class="summary-empty">
                            <div class="summary-empty-icon"></div>
                            <div class="summary-empty-text">All raid drops obtained!</div>
                        </div>`;
                        }

                        // Calculate tomestones needed for summary
                        const tomestonesNeeded = calculateTomestonesNeeded(
                            selectedJob.id,
                            gear,
                            slotTypeOverrides,
                        );
                        const tomestonesFormatted =
                            tomestonesNeeded.toLocaleString();
                        const tomeSummaryHtml =
                            tomestonesNeeded > 0
                                ? `<div class="summary-total">
                               <span class="summary-total-label">Total needed</span>
                               <span class="summary-total-value">${tomestonesFormatted}</span>
                           </div>`
                                : `<div class="summary-empty">
                               <div class="summary-empty-icon"></div>
                               <div class="summary-empty-text">All tome gear upgraded!</div>
                           </div>`;

                        jobInfoHtml = `
                        <div class="job-info">
                            <h3>${selectedJob.name} Gear</h3>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
                                </div>
                                <span class="progress-text ${isComplete ? "complete" : ""}">${progress.complete}/${progress.total} slots complete</span>
                            </div>
                            <div class="gear-layout">
                                <div class="gear-table-container">
                                    <div class="gear-table-grid">
                                        <div class="gear-table-column">
                                            <div class="gear-table-column-header">Left Side</div>
                                            ${leftColumnRows}
                                        </div>
                                        <div class="gear-table-column">
                                            <div class="gear-table-column-header">Right Side</div>
                                            ${rightColumnRows}
                                        </div>
                                    </div>
                                </div>
                                <div class="summary-panel">
                                    <h4>Summary</h4>
                                    <div class="summary-section raid-section">
                                        <div class="summary-section-header">
                                            <div class="summary-section-icon"></div>
                                            <div class="summary-section-title">Raid Drops</div>
                                        </div>
                                        <div class="summary-section-body">
                                            ${raidSummaryHtml}
                                        </div>
                                    </div>
                                    <div class="summary-section tome-section">
                                        <div class="summary-section-header">
                                            <div class="summary-section-icon"></div>
                                            <div class="summary-section-title">Tomestones</div>
                                        </div>
                                        <div class="summary-section-body">
                                            ${tomeSummaryHtml}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    }

                    characterDetails.innerHTML = `
                    ${jobsHtml}
                    ${jobInfoHtml}
                `;

                    // Attach add job button handler
                    document
                        .getElementById("add-job-btn")
                        .addEventListener("click", openJobModal);

                    // Attach job pill click handlers
                    characterDetails
                        .querySelectorAll(".job-pill")
                        .forEach((pill) => {
                            pill.addEventListener("click", (e) => {
                                // Don't select if clicking remove button
                                if (
                                    e.target.classList.contains(
                                        "job-remove-btn",
                                    )
                                )
                                    return;
                                selectJob(pill.dataset.jobId);
                            });
                            pill.addEventListener("keydown", (e) => {
                                if (e.key === "Enter" || e.key === " ") {
                                    e.preventDefault();
                                    selectJob(pill.dataset.jobId);
                                }
                            });
                        });

                    // Attach job remove button handlers
                    characterDetails
                        .querySelectorAll(".job-remove-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                e.stopPropagation();
                                handleRemoveJob(btn.dataset.removeJobId);
                            });
                        });

                    // Attach job icon error handlers
                    characterDetails
                        .querySelectorAll(".job-pill img")
                        .forEach((img) => {
                            img.onerror = () =>
                                handleJobIconError(img, img.dataset.jobId);
                        });

                    // Attach gear checkbox handlers
                    characterDetails
                        .querySelectorAll(
                            '.gear-table-grid input[type="checkbox"]',
                        )
                        .forEach((checkbox) => {
                            checkbox.addEventListener("change", (e) => {
                                handleGearCheckbox(
                                    e.target.dataset.slot,
                                    e.target.dataset.field,
                                    e.target.checked,
                                );
                            });
                        });

                    // Attach slot type toggle handlers
                    characterDetails
                        .querySelectorAll(".slot-type")
                        .forEach((badge) => {
                            badge.addEventListener("click", () => {
                                handleSlotTypeToggle(
                                    badge.dataset.slot,
                                    badge.dataset.type,
                                );
                            });
                            badge.addEventListener("keydown", (e) => {
                                if (e.key === "Enter" || e.key === " ") {
                                    e.preventDefault();
                                    handleSlotTypeToggle(
                                        badge.dataset.slot,
                                        badge.dataset.type,
                                    );
                                }
                            });
                        });
                }

                // Ring validation helper
                // Returns { valid: boolean, message: string } for proposed ring state change
                function validateRingChange(
                    jobId,
                    gear,
                    slotId,
                    field,
                    checked,
                    slotTypeOverrides,
                ) {
                    // Only validate ring slots
                    if (slotId !== "ring1" && slotId !== "ring2") {
                        return { valid: true, message: "" };
                    }

                    // Only validate when checking (not unchecking)
                    if (!checked) {
                        return { valid: true, message: "" };
                    }

                    const otherRingSlot =
                        slotId === "ring1" ? "ring2" : "ring1";
                    const thisRingType = getSlotType(
                        jobId,
                        slotId,
                        slotTypeOverrides,
                    );
                    const otherRingType = getSlotType(
                        jobId,
                        otherRingSlot,
                        slotTypeOverrides,
                    );
                    const otherRingGear = gear[otherRingSlot] || {};

                    // RING-001: Cannot have two raid rings
                    if (field === "have" && thisRingType === "raid") {
                        if (otherRingType === "raid" && otherRingGear.have) {
                            return {
                                valid: false,
                                message:
                                    "Cannot have two raid rings equipped. You must uncheck the other raid ring first.",
                            };
                        }
                    }

                    // RING-002: Cannot have two tome rings at same upgrade level
                    if (thisRingType === "tome" && otherRingType === "tome") {
                        if (field === "base" && !checked) {
                            // Unchecking base is always allowed
                            return { valid: true, message: "" };
                        }

                        // Calculate what the state would be after this change
                        const thisGear = gear[slotId] || {};
                        let thisWouldBeBase =
                            field === "base" ? checked : thisGear.base || false;
                        let thisWouldBeUpgraded =
                            field === "upgraded"
                                ? checked
                                : thisGear.upgraded || false;

                        // If checking upgraded, base would also be auto-checked (GEAR-004)
                        if (field === "upgraded" && checked) {
                            thisWouldBeBase = true;
                        }

                        const otherIsBase = otherRingGear.base || false;
                        const otherIsUpgraded = otherRingGear.upgraded || false;

                        // Check for duplicate base-only (neither upgraded)
                        if (
                            thisWouldBeBase &&
                            !thisWouldBeUpgraded &&
                            otherIsBase &&
                            !otherIsUpgraded
                        ) {
                            return {
                                valid: false,
                                message:
                                    "Cannot have two tome rings at the same upgrade level. Upgrade one ring first.",
                            };
                        }

                        // Check for duplicate upgraded
                        if (thisWouldBeUpgraded && otherIsUpgraded) {
                            return {
                                valid: false,
                                message:
                                    "Cannot have two upgraded tome rings. You must uncheck the upgrade on one ring first.",
                            };
                        }
                    }

                    return { valid: true, message: "" };
                }

                function handleGearCheckbox(slotId, field, checked) {
                    const selected = state.characters.find(
                        (c) => c.id === state.selectedCharacterId,
                    );
                    if (!selected) return;

                    const jobData = selected.jobs.find(
                        (j) => j.jobId === state.selectedJobId,
                    );
                    if (!jobData) return;

                    // Initialize gear object if needed
                    if (!jobData.gear) jobData.gear = {};
                    if (!jobData.gear[slotId]) jobData.gear[slotId] = {};

                    // Validate ring changes
                    const slotTypeOverrides = jobData.slotTypeOverrides || {};
                    const validation = validateRingChange(
                        state.selectedJobId,
                        jobData.gear,
                        slotId,
                        field,
                        checked,
                        slotTypeOverrides,
                    );
                    if (!validation.valid) {
                        alert(validation.message);
                        render(); // Re-render to reset checkbox state
                        return;
                    }

                    // Update the field
                    jobData.gear[slotId][field] = checked;

                    // GEAR-004: Auto-check Base when Upgraded is checked
                    if (field === "upgraded" && checked) {
                        jobData.gear[slotId].base = true;
                    }

                    saveState();
                    render();
                }

                function handleSlotTypeToggle(slotId, currentType) {
                    // Open the slot config modal instead of toggling directly
                    openSlotConfigModal(slotId, currentType);
                }

                // Utilities
                function escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                // Handle job icon load error - show fallback text
                function handleJobIconError(img, jobId) {
                    img.classList.add("hidden");
                    // Create fallback element if it doesn't exist
                    if (
                        !img.nextElementSibling ||
                        !img.nextElementSibling.classList.contains(
                            "job-icon-fallback",
                        )
                    ) {
                        const fallback = document.createElement("span");
                        fallback.className = "job-icon-fallback";
                        fallback.textContent = jobId;
                        img.parentNode.insertBefore(fallback, img.nextSibling);
                    }
                }

                // Start the app
                init();
            })();
        </script>
    </body>
</html>
